<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Tape Testing UI - Responsive demo with sidebar, playground, and controls" />
	<!-- Content Security Policy -->
	<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';" />
	<meta http-equiv="X-Content-Type-Options" content="nosniff" />
	<meta http-equiv="X-Frame-Options" content="DENY" />
	<meta http-equiv="X-XSS-Protection" content="1; mode=block" />
	<meta name="referrer" content="no-referrer" />
	<title>TapeTesting</title>
	<!-- Link CSS files for responsive layouts -->
	<link rel="stylesheet" href="./display and css/desktop.css" />
	<link rel="stylesheet" href="./display and css/tablet.css" />
	<link rel="stylesheet" href="./display and css/phone.css" />
	<style>
		:root {
			--gap: 16px;
			--item-bg: #f3f4f6;
			--accent: #0ea5a4;
			--sidebar-width: 20vw;
			--bottom-height: calc(20vh - 15px);
			--sidebar-height: auto;
			--primary-color: #2563eb;
			--secondary-color: #fef3c7;
		}

		html, body {
			height: 100%;
			margin: 0;
			font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			background: #fff;
		}

		body {
			display: flex;
			flex-direction: column;
		}

		/* Main app layout */
		.app-container {
			display: flex;
			flex: 1;
			position: relative;
			min-height: 100vh;
		}

		/* Sidebar */
		.sidebar {
			position: fixed;
			left: 0;
			top: 0;
			bottom: 0;
			width: var(--sidebar-width);
			background: #fff;
			border-right: 4px solid var(--primary-color);
			padding: 16px;
			box-sizing: border-box;
			z-index: 2;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 16px;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.sidebar.hidden {
			transform: translateX(-100%);
			opacity: 0;
			pointer-events: none;
		}

		.sidebar-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			border-radius: 4px;
			padding: 12px 16px;
			background: #fff;
			cursor: pointer;
			font-size: 0.95rem;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
			text-align: left;
		}

		/* Tooltip for sidebar buttons (small helper text on hover) */
		/* Hide the earlier pseudo-element tooltips; we'll use a floating tooltip appended to <body> */
		.sidebar-btn[data-tip]::after,
		.sidebar-btn[data-tip]::before,
		.save-btn[data-tip]::after,
		.save-btn[data-tip]::before {
			display: none !important;
		}

		/* Floating tooltip that sits on top of everything */
		.floating-tip {
			position: fixed;
			display: none;
			background: rgba(17, 24, 39, 0.95);
			color: #fff;
			padding: 6px 10px;
			border-radius: 6px;
			font-size: 0.78rem;
			white-space: nowrap;
			z-index: 99999;
			pointer-events: none; /* disabled until visible so it won't block interactions */
			box-shadow: 0 8px 24px rgba(0,0,0,0.2);
			transition: opacity 0.12s ease;
			opacity: 0;
		}

		.floating-tip.show {
			display: block;
			opacity: 1;
			pointer-events: auto; /* allow mouse to enter the tip itself so it can cancel hide */
		}

		.sidebar-btn:hover {
			background: #eff6ff;
		}

		.sidebar-btn.active {
			background: #eff6ff;
			border-color: #1e40af;
		}

		.sidebar-btn svg {
			width: 18px;
			height: 18px;
			stroke: currentColor;
		}

		.sidebar-divider {
			border-top: 1px solid #93c5fd;
			margin: 8px 0;
		}

		/* Save button - full width, blue fill */
		.save-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			background: var(--primary-color);
			color: #fff;
			border-radius: 4px;
			padding: 12px 16px;
			cursor: pointer;
			font-size: 0.95rem;
			font-weight: 600;
			transition: all 0.2s ease;
		}

		.save-btn:hover {
			background: #1e40af;
			border-color: #1e40af;
		}

		.save-btn.active {
			background: #fff;
			color: var(--primary-color);
			border-color: var(--primary-color);
		}

		/* Playground / Main content area */
		.playground {
			margin-left: var(--sidebar-width);
			margin-bottom: var(--bottom-height);
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto;
			background: #fff;
			flex: 1;
			transition: margin-left 0.3s ease, margin-bottom 0.3s ease;
			position: relative;
			height: calc(100vh - var(--bottom-height));
		}

		.playground.preview-mode {
			margin-left: 0;
			margin-bottom: 0;
			height: 100vh;
		}

		/* Background environment image */
		.playground-background {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 0;
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
			opacity: 0;
			transition: opacity 0.5s ease;
			pointer-events: none;
		}

		.playground-background.visible {
			opacity: 0.4;
		}

		/* Sticker note - always visible, centered */
		.playground-sticker {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 700px;
			max-width: 80%;
			height: auto;
			z-index: 0.5;
			opacity: 0.9;
			pointer-events: none;
		}

		/* Preview surface material image - appears in preview mode only */
		.preview-surface-image {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(calc(-50% + 150px), -50%);
			width: 200px;
			height: 320px;
			z-index: 1;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.5s ease;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
			object-fit: cover;
			object-position: center;
			border: 2px solid rgba(255, 255, 255, 0.8);
		}

		.preview-surface-image.visible {
			opacity: 0.95;
		}

		/* Preview variant tape images - appears in preview mode only when variant button is active */
		.preview-tape-image {
			position: absolute;
			left: 50%;
			transform: translateX(calc(-50% - 150px));
			width: 200px;
			height: 200px;
			z-index: 1;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.5s ease;
			object-fit: cover;
			object-position: center;
		}

		.preview-tape-image.tape1 {
			top: calc(50% - 220px);
		}

		.preview-tape-image.tape2 {
			top: calc(50% + 20px);
		}

		.preview-tape-image.visible {
			opacity: 0.95;
		}

		/* Preview regular tape image - appears in preview mode when regular tape is selected */
		.preview-regular-tape-image {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(calc(-50% - 140px), -50%);
			width: 200px;
			height: 200px;
			z-index: 1;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.5s ease;
			object-fit: cover;
			object-position: center;
		}

		.preview-regular-tape-image.visible {
			opacity: 0.95;
		}

		/* Preview sticker image - slides in from left when variant button is active */
		.preview-sticker-variant {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%) translateX(-650px);
			width: 133px;
			height: auto;
			z-index: 2;
			opacity: 0;
			pointer-events: none;
			transition: transform 0.8s ease-out, opacity 0.4s ease 0.3s;
		}

		.preview-sticker-variant.visible {
			transform: translate(-50%, -50%) translateX(20px);
			opacity: 1;
		}

		/* Regular tape dropdown - appears in preview mode */
		.regular-tape-dropdown {
			position: fixed;
			left: 30px;
			top: 50%;
			transform: translateY(-50%) translateX(-300px);
			width: 250px;
			max-height: 400px;
			background: rgba(0, 0, 0, 0.9);
			backdrop-filter: blur(8px);
			border: 2px solid rgba(255, 255, 255, 0.2);
			border-radius: 12px;
			padding: 16px;
			z-index: 42;
			opacity: 0;
			pointer-events: none;
			transition: transform 0.3s ease, opacity 0.3s ease;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
		}

		.regular-tape-dropdown.show {
			transform: translateY(-50%) translateX(0);
			opacity: 1;
			pointer-events: auto;
		}

		.regular-tape-dropdown h3 {
			margin: 0 0 12px 0;
			font-size: 1rem;
			font-weight: 600;
			color: #fff;
			text-align: center;
			padding-bottom: 8px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
		}

		.regular-tape-options {
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 320px;
			overflow-y: auto;
		}

		.regular-tape-option {
			background: rgba(255, 255, 255, 0.1);
			padding: 12px;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s ease;
			border: 2px solid transparent;
		}

		.regular-tape-option:hover {
			background: rgba(255, 255, 255, 0.2);
			border-color: rgba(96, 165, 250, 0.5);
		}

		.regular-tape-option.selected {
			background: rgba(37, 99, 235, 0.4);
			border-color: #60a5fa;
		}

		.regular-tape-option .tape-name {
			font-size: 0.9rem;
			font-weight: 600;
			color: #fff;
			margin-bottom: 4px;
		}

		.regular-tape-option .tape-specs {
			font-size: 0.75rem;
			color: rgba(255, 255, 255, 0.7);
			line-height: 1.4;
		}

		/* Surface selection dropdown - appears in preview mode */
		.surface-selection-dropdown {
			position: fixed;
			left: 30px;
			top: 50%;
			transform: translateY(-50%) translateX(-300px);
			width: 250px;
			max-height: 400px;
			background: rgba(0, 0, 0, 0.9);
			backdrop-filter: blur(8px);
			border: 2px solid rgba(255, 255, 255, 0.2);
			border-radius: 12px;
			padding: 16px;
			z-index: 42;
			opacity: 0;
			pointer-events: none;
			transition: transform 0.3s ease, opacity 0.3s ease;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
		}

		.surface-selection-dropdown.show {
			transform: translateY(-50%) translateX(0);
			opacity: 1;
			pointer-events: auto;
		}

		.surface-selection-dropdown h3 {
			margin: 0 0 12px 0;
			font-size: 1rem;
			font-weight: 600;
			color: #fff;
			text-align: center;
			padding-bottom: 8px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.2);
		}

		.surface-selection-options {
			display: flex;
			flex-direction: column;
			gap: 8px;
			max-height: 320px;
			overflow-y: auto;
		}

		.surface-selection-option {
			background: rgba(255, 255, 255, 0.1);
			padding: 12px;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.2s ease;
			border: 2px solid transparent;
			color: #fff;
			font-weight: 600;
		}

		.surface-selection-option:hover {
			background: rgba(255, 255, 255, 0.2);
			border-color: rgba(96, 165, 250, 0.5);
		}

		.surface-selection-option.selected {
			background: rgba(37, 99, 235, 0.4);
			border-color: #60a5fa;
		}

		.surface-selection-option .surface-name {
			font-size: 0.9rem;
			font-weight: 600;
			color: #fff;
		}

		.content-panel {
			border: 4px solid var(--primary-color);
			border-radius: 4px;
			background: #f9fafb;
			padding: 24px;
			overflow-y: auto;
			max-height: calc(100vh - var(--bottom-height) - 48px);
			height: fit-content;
			box-sizing: border-box;
			padding-bottom: 40px;
			transition: opacity 0.3s ease, transform 0.3s ease;
			position: relative;
			z-index: 1;
		}

		.playground.preview-mode .content-panel {
			opacity: 0;
			transform: scale(0.95);
			pointer-events: none;
		}

		.content-panel h2 {
			font-size: 1.5rem;
			font-weight: 600;
			margin: 0 0 16px 0;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 16px;
			max-width: 400px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.form-group label {
			font-size: 0.9rem;
			font-weight: 500;
		}

		.form-group input,
		.form-group select {
			padding: 8px 12px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			font-size: 0.95rem;
			box-sizing: border-box;
		}

		.form-group input:focus,
		.form-group select:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}

		.preview-box {
			margin: 24px 0;
			padding: 16px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			background: #fff;
			min-height: 200px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.preview-content {
			text-align: center;
			border: 2px dashed #d1d5db;
			padding: 40px;
			border-radius: 4px;
			width: 100%;
		}

		.preview-content .title {
			font-size: 1.1rem;
			font-weight: 500;
		}

		.preview-content .subtitle {
			font-size: 0.9rem;
			color: #6b7280;
			margin-top: 8px;
		}

		.history-list {
			list-style: none;
			padding: 0;
			margin: 0;
			max-height: 280px;
			overflow-y: auto;
		}

		.history-list li {
			padding: 8px;
			font-size: 0.85rem;
			border-bottom: 1px solid #e5e7eb;
		}

		.history-list li:last-child {
			border-bottom: none;
		}

		.guidelines-box {
			margin-top: 24px;
			padding: 16px;
			border: 1px solid #fbbf24;
			background: #fef3c7;
			border-radius: 4px;
		}

		.guidelines-box h3 {
			margin: 0 0 12px 0;
			font-weight: 600;
		}

		.guidelines-box ol {
			margin: 0;
			padding-left: 20px;
			font-size: 0.9rem;
		}

		/* Time slider in preview mode - Vertical on right side */
		.preview-slider-container {
			position: fixed;
			right: 30px;
			top: 50%;
			transform: translateY(-50%);
			height: 400px;
			max-height: 70vh;
			background: rgba(0, 0, 0, 0.85);
			padding: 24px 20px;
			border-radius: 12px;
			z-index: 41;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
			backdrop-filter: blur(8px);
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 16px;
		}

		.preview-slider-container.show {
			opacity: 1;
			pointer-events: auto;
		}

		.slider-label {
			font-size: 0.75rem;
			color: rgba(255, 255, 255, 0.9);
			text-align: center;
			font-weight: 500;
			writing-mode: vertical-rl;
			text-orientation: mixed;
			transform: rotate(180deg);
			margin: 0;
		}

		.time-slider {
			width: 6px;
			height: 100%;
			writing-mode: vertical-lr;
			direction: rtl;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 3px;
			outline: none;
			cursor: pointer;
			flex: 1;
		}

		.time-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 18px;
			height: 18px;
			background: #3b82f6;
			border: 2px solid #fff;
			border-radius: 50%;
			cursor: grab;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}

		.time-slider::-webkit-slider-thumb:hover {
			background: #2563eb;
			box-shadow: 0 3px 12px rgba(0,0,0,0.4);
		}

		.time-slider::-webkit-slider-thumb:active {
			cursor: grabbing;
			box-shadow: 0 4px 16px rgba(0,0,0,0.5);
		}

		.time-slider::-moz-range-thumb {
			width: 18px;
			height: 18px;
			background: #3b82f6;
			border: 2px solid #fff;
			border-radius: 50%;
			cursor: grab;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}

		.time-slider::-moz-range-thumb:hover {
			background: #2563eb;
			box-shadow: 0 3px 12px rgba(0,0,0,0.4);
		}

		.time-slider::-moz-range-thumb:active {
			cursor: grabbing;
			box-shadow: 0 4px 16px rgba(0,0,0,0.5);
		}

		.slider-value-display {
			text-align: center;
			font-size: 0.9rem;
			color: rgba(255, 255, 255, 0.9);
			font-weight: 600;
		}

		.slider-current-value {
			color: #60a5fa;
			font-size: 1.15rem;
			font-weight: 700;
			text-shadow: 0 1px 3px rgba(0,0,0,0.3);
			display: block;
		}

		/* Preview mode left buttons */
		.preview-left-buttons {
			position: fixed;
			left: 30px;
			top: 50%;
			transform: translateY(-50%);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			gap: 16px;
			z-index: 41;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.preview-left-buttons.show {
			opacity: 1;
			pointer-events: auto;
		}

		.preview-tape-btn {
			background: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(8px);
			border: 2px solid rgba(255, 255, 255, 0.2);
			color: #fff;
			padding: 16px 24px;
			border-radius: 12px;
			font-size: 0.95rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			text-align: center;
			min-width: 140px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}

		.preview-tape-btn:hover {
			background: rgba(37, 99, 235, 0.9);
			border-color: rgba(255, 255, 255, 0.4);
			box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
			transform: translateX(5px);
		}

		.preview-tape-btn.active {
			background: rgba(37, 99, 235, 0.95);
			border-color: #60a5fa;
			box-shadow: 0 4px 12px rgba(37, 99, 235, 0.5);
		}

		/* PEEL button - bottom right in preview mode */
		.peel-btn {
			position: fixed;
			bottom: 40px;
			right: 40px;
			background: rgba(220, 38, 38, 0.9);
			backdrop-filter: blur(8px);
			border: 3px solid rgba(255, 255, 255, 0.3);
			color: #fff;
			padding: 20px 40px;
			border-radius: 16px;
			font-size: 1.2rem;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
			box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
			z-index: 150;
			opacity: 0;
			pointer-events: none;
			transform: translateY(20px);
			letter-spacing: 2px;
		}

		.peel-btn.show {
			opacity: 1;
			pointer-events: auto;
			transform: translateY(0);
		}

		.peel-btn:hover {
			background: rgba(239, 68, 68, 1);
			border-color: rgba(255, 255, 255, 0.6);
			box-shadow: 0 8px 28px rgba(220, 38, 38, 0.7);
			transform: translateY(-3px) scale(1.05);
		}

		.peel-btn:active {
			transform: translateY(0) scale(0.98);
		}

		.peel-btn.disabled {
			background: rgba(107, 114, 128, 0.6);
			border-color: rgba(255, 255, 255, 0.1);
			cursor: not-allowed;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		}

		.peel-btn.disabled:hover {
			transform: translateY(0) scale(1);
		}

		/* PEEL hint text */
		.peel-hint {
			position: fixed;
			bottom: 20px;
			right: 180px;
			font-size: 0.7rem;
			color: rgba(255, 255, 255, 1);
			max-width: 200px;
			text-align: right;
			line-height: 1.3;
			z-index: 149;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.peel-hint.show {
			opacity: 1;
		}

		/* Damage assessment signs */
		.damage-sign {
			position: absolute;
			width: 300px;
			height: 300px;
			z-index: 100;
			opacity: 0;
			pointer-events: none;
			display: none;
			transition: opacity 0.3s ease;
			visibility: hidden;
			transform-origin: center center;
		}
		
		.damage-sign.ok,
		.damage-sign.oops,
		.damage-sign.boom {
			visibility: visible !important;
			display: block !important;
		}

		/* OK sign - bounce animation */
		.damage-sign.ok {
			animation: bounce-ok 1.5s ease-out forwards;
		}

		@keyframes bounce-ok {
			0% {
				opacity: 0;
				transform: translate(-50%, -50%) scale(0.3);
			}
			30% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1.2);
			}
			50% {
				transform: translate(-50%, -50%) scale(0.9);
			}
			70% {
				transform: translate(-50%, -50%) scale(1.05);
			}
			100% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1);
			}
		}

		/* OOPS sign - vibrate and stretch */
		.damage-sign.oops {
			animation: vibrate-oops 2s ease-in-out forwards;
		}

		@keyframes vibrate-oops {
			0% {
				opacity: 0;
				transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
			}
			15% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1.3) rotate(-5deg);
			}
			20% {
				transform: translate(-50%, -50%) scale(1.3) rotate(5deg);
			}
			25% {
				transform: translate(-50%, -50%) scale(1.2) rotate(-5deg);
			}
			30% {
				transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
			}
			35% {
				transform: translate(-50%, -50%) scale(1.1) rotate(-3deg);
			}
			40% {
				transform: translate(-50%, -50%) scale(1.1) rotate(3deg);
			}
			45% {
				transform: translate(-50%, -50%) scale(1.05) rotate(-2deg);
			}
			50% {
				transform: translate(-50%, -50%) scale(1.05) rotate(2deg);
			}
			60% {
				transform: translate(-50%, -50%) scale(1.0) rotate(0deg);
			}
			100% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1) rotate(0deg);
			}
		}

		/* BOOM sign - erratic jump and flip */
		.damage-sign.boom {
			animation: erratic-boom 2.5s ease-in-out forwards;
		}

		@keyframes erratic-boom {
			0% {
				opacity: 0;
				transform: translate(-50%, -50%) scale(0.2) rotate(0deg);
			}
			10% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
			}
			20% {
				transform: translate(-50%, -50%) scale(1.2) rotate(360deg);
			}
			30% {
				transform: translate(-50%, -50%) scale(1.4) rotate(540deg);
			}
			40% {
				transform: translate(-50%, -50%) scale(1.1) rotate(720deg);
			}
			50% {
				transform: translate(-50%, -50%) scale(1.3) rotate(900deg);
			}
			60% {
				transform: translate(-50%, -50%) scale(1.15) rotate(1080deg);
			}
			70% {
				transform: translate(-50%, -50%) scale(1.25) rotate(1260deg);
			}
			80% {
				transform: translate(-50%, -50%) scale(1.1) rotate(1440deg);
			}
			90% {
				transform: translate(-50%, -50%) scale(1.05) rotate(1620deg);
			}
			100% {
				opacity: 1;
				transform: translate(-50%, -50%) scale(1) rotate(1800deg);
			}
		}

		/* Bottom bar */
		.bottombar {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			height: var(--bottom-height);
			background: #fff;
			border-top: 4px solid var(--primary-color);
			padding: 0;
			box-sizing: border-box;
			z-index: 3;
			display: flex;
			align-items: center;
			justify-content: space-between;
			overflow: hidden;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.bottombar.hidden {
			transform: translateY(100%);
			opacity: 0;
			pointer-events: none;
		}

		.bottom-content {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 100%;
			padding: 40px 20px;
			box-sizing: border-box;
			gap: 20px;
		}

		.material-selector {
			position: relative;
			display: flex;
			flex: 1;
			min-width: 0;
		}

		.material-btn {
			border: 2px solid var(--primary-color);
			background: #fff;
			border-radius: 4px;
			padding: 8px 17px;
			cursor: pointer;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			transition: all 0.2s ease;
			flex: 1;
			min-width: 0;
		}

		.material-btn:hover {
			background: #eff6ff;
		}

		.material-badge {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: #fbcfe8;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.material-dropdown {
			position: fixed;
			width: 160px;
			background: #fff;
			border: 2px solid #93c5fd;
			border-radius: 4px;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
			padding: 12px;
			z-index: 100000;
			display: none;
			pointer-events: auto;
		}

		.material-dropdown.open {
			display: block;
		}

		/* Material popup windows - appear above bottom buttons */
		.material-popup {
			position: fixed;
			bottom: calc(var(--bottom-height) + 20px);
			width: 44%;
			max-width: 500px;
			height: 280px;
			border: 6px solid var(--primary-color);
			border-radius: 8px;
			background: white;
			box-shadow: 0 8px 28px rgba(0, 0, 0, 0.15);
			z-index: 100001;
			display: none;
			opacity: 0;
			transform: translateY(10px) scale(0.98);
			transition: transform 0.18s cubic-bezier(0.2, 0.9, 0.2, 1), opacity 0.12s;
			box-sizing: border-box;
			overflow: hidden;
		}

		.material-popup.left { left: 6%; }
		.material-popup.right { right: 6%; }

		.material-popup.open {
			display: flex;
			opacity: 1;
			transform: translateY(-10px) scale(1);
		}

		.popup-inner-content {
			flex: 1;
			display: flex;
			padding: 18px;
			box-sizing: border-box;
			position: relative;
		}

		.popup-frame {
			flex: 1;
			border: 4px solid rgba(37, 99, 235, 0.15);
			border-radius: 6px;
			padding: 16px;
			box-sizing: border-box;
			background: #fbfbfb;
			overflow-y: auto;
			overflow-x: hidden;
			position: relative;
		}

		.popup-close {
			position: absolute;
			top: 12px;
			right: 12px;
			border: none;
			background: transparent;
			font-size: 24px;
			line-height: 1;
			cursor: pointer;
			color: #6b7280;
			padding: 4px 8px;
			transition: color 0.2s ease;
			z-index: 10;
		}

		.popup-close:hover { color: #1f2937; }

		.popup-title {
			margin: 0 0 16px 0;
			font-size: 1.2rem;
			font-weight: 600;
			color: #1f2937;
		}

		.mixing-header {
			font-size: 0.75rem;
			color: #6b7280;
			margin: 0 0 12px 0;
			padding-bottom: 8px;
			border-bottom: 1px solid rgba(37, 99, 235, 0.2);
			text-align: center;
		}

		.tape-columns-container {
			display: flex;
			gap: 12px;
			width: 100%;
		}

		.tape-column {
			flex: 1;
			min-width: 0;
		}

		/* Vertical scrollbar handle */
		.popup-scrollbar {
			width: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 4px;
		}

		.scrollbar-track {
			width: 6px;
			background: #e5e7eb;
			border-radius: 8px;
			height: 180px;
			position: relative;
		}

		.scrollbar-thumb {
			width: 6px;
			height: 60px;
			background: var(--primary-color);
			border-radius: 4px;
			position: absolute;
			top: 0;
			transition: top 0.1s ease;
		}

		/* Tape material pills (left popup) */
		.material-pills {
			display: flex;
			flex-direction: column;
			gap: 8px;
			padding: 4px;
		}

		.material-pill {
			background: #eff6ff;
			padding: 14px 20px;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 500;
			color: #1f2937;
			box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.03);
			cursor: pointer;
			transition: all 0.2s ease;
			border: 2px solid transparent;
		}

		.material-pill:hover {
			background: #dbeafe;
			transform: translateX(4px);
		}

		.material-pill.selected {
			background: #bfdbfe;
			border-color: var(--primary-color);
			font-weight: 600;
		}

		/* Surface material grid (right popup) */
		.material-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
			align-items: start;
			justify-items: center;
		}

		.material-tile-wrap {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 8px;
			cursor: pointer;
		}

		.material-tile {
			width: 110px;
			height: 75px;
			border: 4px solid rgba(37, 99, 235, 0.2);
			border-radius: 6px;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			box-sizing: border-box;
			background: white;
			transition: all 0.2s ease;
			overflow: hidden;
		}

		.material-tile-wrap:hover .material-tile {
			border-color: var(--primary-color);
			transform: translateY(-3px);
			box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
		}

		.material-tile.selected {
			border-color: var(--primary-color);
			border-width: 5px;
			box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
		}

		.material-tile svg {
			width: 100%;
			height: 100%;
		}

		.material-tile img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			object-position: center;
		}

		.material-tile img[src*="glass.png"] {
			transform: rotate(90deg);
			width: 140%;
			height: 140%;
		}

		.material-tile-label {
			font-size: 0.85rem;
			text-align: center;
			color: #4b5563;
			font-weight: 500;
		}

		.bottom-right {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 12px;
			margin-left: auto;
			flex-shrink: 0;
		}

		.bottom-right .status {
			font-size: 0.85rem;
			color: #4b5563;
		}

		.apply-btn {
			padding: 8px 16px;
			border: 1px solid var(--primary-color);
			background: #fff;
			color: var(--primary-color);
			border-radius: 4px;
			cursor: pointer;
			font-weight: 500;
			transition: all 0.2s ease;
		}

		.apply-btn:hover {
			background: #eff6ff;
		}

		.save-notice {
			position: fixed;
			bottom: 30px;
			right: 20px;
			background: #dcfce7;
			border: 1px solid #86efac;
			padding: 12px 16px;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			z-index: 50;
			display: none;
		}

		.save-notice.show {
			display: block;
		}

		/* Preview mode hint */
		.preview-hint {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			padding: 12px 20px;
			border-radius: 24px;
			font-size: 0.85rem;
			text-align: center;
			z-index: 40;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.preview-hint.show {
			opacity: 1;
			pointer-events: auto;
		}

		/* QR Code */
		.qr-code {
			display: none;
			margin: 20px auto 0;
			text-align: center;
			position: relative;
			z-index: 1;
		}

		.qr-code.show {
			display: block;
		}

		.qr-code img {
			width: 200px;
			height: auto;
			display: inline-block;
		}

		/* Phone/responsive */
		@media (max-width: 480px) {
			:root {
				--sidebar-width: 100vw;
				--bottom-height: 20vh;
				--sidebar-height: 20vh;
			}

			.sidebar {
				position: fixed;
				left: 0;
				right: 0;
				top: 0;
				height: var(--sidebar-height);
				width: 100%;
				bottom: auto;
				border-right: none;
				border-bottom: 4px solid var(--primary-color);
				z-index: 3;
				flex-direction: row;
				overflow-x: auto;
				padding: 8px;
			}

			.sidebar-btn {
				flex-shrink: 0;
				min-width: 100px;
				padding: 8px 12px;
				font-size: 0.85rem;
			}

			.sidebar-divider {
				display: none;
			}

			.playground {
				margin-left: 0;
				margin-top: var(--sidebar-height);
				margin-bottom: var(--bottom-height);
				min-height: calc(100vh - var(--sidebar-height) - var(--bottom-height));
			}

			.bottombar {
				left: 0;
				right: 0;
				bottom: 0;
			}

			.bottom-content {
				flex-wrap: wrap;
				justify-content: center;
				padding: 8px 12px;
			}

			.bottom-right {
				width: 100%;
				justify-content: center;
				margin-left: 0;
				margin-top: 8px;
			}

			.preview-slider-container {
				right: 10px;
				height: 50vh;
				max-height: 50vh;
				padding: 16px 12px;
			}

			/* Phone: Move preview buttons to top horizontal layout */
			.preview-left-buttons {
				left: 50%;
				top: 20px;
				transform: translateX(-50%);
				flex-direction: row;
				flex-wrap: wrap;
				justify-content: center;
				gap: 8px;
				max-width: 95vw;
			}

			.preview-tape-btn {
				padding: 10px 16px;
				font-size: 0.8rem;
				min-width: auto;
				flex: 0 1 auto;
			}

			.preview-tape-btn:hover {
				transform: translateY(-2px);
			}

			/* Exit preview button red styling for phone */
			.preview-exit-btn {
				background: rgba(220, 38, 38, 0.85) !important;
				border-color: rgba(255, 255, 255, 0.3) !important;
			}

			.preview-exit-btn:hover {
				background: rgba(220, 38, 38, 0.95) !important;
				transform: translateY(-2px);
			}

			.form-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar -->
		<aside class="sidebar" aria-label="Sidebar">
			<button class="sidebar-btn active" data-panel="dimensions" data-tip="Set width & height">
				<div style="display: flex; align-items: center; gap: 8px;">
					<span class="material-badge" style="width: 20px; height: 20px; font-size: 0.7rem;">V</span>
					<span>Dimensions</span>
				</div>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="specifics" data-tip="Thickness, adhesive, tolerances">
				<div style="display: flex; align-items: center; gap: 8px;">
					<span class="material-badge" style="width: 20px; height: 20px; font-size: 0.7rem;">V</span>
					<span>Specifics</span>
				</div>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="environment" data-tip="Temperature & humidity">
				<span>Environment</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>

			<button class="save-btn" data-panel="save" data-tip="Save current parameters">
				Save Parameters
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" id="previewBtn" title="Preview mode - hides sidebar and bottom bar" data-tip="Toggle full-screen preview">
				Preview
			</button>

		<button class="sidebar-btn" data-panel="history" data-tip="View recent changes">
			<div style="display: flex; align-items: center; gap: 8px;">
				<span class="material-badge" style="width: 20px; height: 20px; font-size: 0.7rem;">V</span>
				<span>History Log</span>
			</div>
		</button>			<button class="sidebar-btn" data-panel="guidelines" data-tip="Show design guidelines">
				Guidelines
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" id="resetBtn" data-tip="Reset all parameters">
				RESET
			</button>
		</aside>

		<!-- Main Playground -->
		<section class="playground" aria-label="Playground">
			<div class="playground-background" id="playgroundBackground"></div>
			<img src="./images/Sticker_note.jpg" alt="Sticker note" class="playground-sticker" />
			<img src="" alt="Surface material" class="preview-surface-image" id="previewSurfaceImage" />
			<img src="" alt="Tape 1" class="preview-tape-image tape1" id="previewTapeImage1" />
			<img src="" alt="Tape 2" class="preview-tape-image tape2" id="previewTapeImage2" />
			<img src="" alt="Regular Tape" class="preview-regular-tape-image" id="previewRegularTapeImage" />
			<img src="./images/stickers.png" alt="Variant sticker" class="preview-sticker-variant" id="previewStickerVariant" />
			<!-- Damage assessment signs -->
			<img src="" alt="Damage sign" class="damage-sign" id="damageSign" />
			<div class="content-panel" id="contentPanel">
				<!-- Content inserted here by JS -->
			</div>
		</section>

		<!-- Bottom Bar -->
		<div class="bottombar" aria-label="Bottom bar">
			<div class="bottom-content">
				<div class="material-selector">
					<button class="material-btn" id="variantBtn">
						<span class="material-badge">V</span>
						<span>Variant</span>
					</button>
				</div>

				<div class="material-selector">
					<button class="material-btn" id="tapeMaterialBtn">
						<span class="material-badge">T</span>
						<span>Tape Material</span>
					</button>
				</div>

				<div class="material-selector">
					<button class="material-btn" id="surfaceMaterialBtn">
						<span class="material-badge">S</span>
						<span>Surface Material</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Material popup windows -->
	<!-- Tape Material Popup (Left) -->
	<div class="material-popup left" id="tapePopup">
		<div class="popup-inner-content">
			<div class="popup-frame">
				<button class="popup-close" id="closeTapePopup" title="Close">&times;</button>
				<h3 class="popup-title">Tape Materials</h3>
				<div class="mixing-header">Choose types for mixing</div>
				<div class="tape-columns-container">
					<div class="tape-column">
						<div class="material-pills" id="tapePills1">
							<!-- Pills added by JS -->
						</div>
					</div>
					<div class="tape-column">
						<div class="material-pills" id="tapePills2">
							<!-- Pills added by JS -->
						</div>
					</div>
				</div>
			</div>
			<div class="popup-scrollbar">
				<div class="scrollbar-track">
					<div class="scrollbar-thumb" id="tapeScrollThumb"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Surface Material Popup (Right) -->
	<div class="material-popup right" id="surfacePopup">
		<div class="popup-inner-content">
			<div class="popup-frame">
				<button class="popup-close" id="closeSurfacePopup" title="Close">&times;</button>
				<h3 class="popup-title">Surface Materials</h3>
				<div class="material-grid" id="surfaceGrid">
					<!-- Tiles added by JS -->
				</div>
			</div>
			<div class="popup-scrollbar">
				<div class="scrollbar-track">
					<div class="scrollbar-thumb" id="surfaceScrollThumb"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Save notice -->
	<div class="save-notice" id="saveNotice">Saved</div>

	<!-- Scripts -->
	<!-- Preview mode hint -->
	<div class="preview-hint" id="previewHint">Press ESC to exit preview mode</div>

	<!-- Time slider in preview mode -->
	<div class="preview-slider-container" id="previewSlider">
		<div class="slider-value-display">
			<span class="slider-current-value"><span id="sliderValue">0</span> days</span>
		</div>
		<input type="range" min="0" max="366" value="0" class="time-slider" id="timeSlider" orient="vertical" />
		<div class="slider-label">Time Impact</div>
	</div>

	<!-- Left buttons in preview mode -->
	<div class="preview-left-buttons" id="previewLeftButtons">
		<button class="preview-tape-btn" id="variantTapeBtn">Variant Tape</button>
		<button class="preview-tape-btn" id="regularTapeBtn">Regular Tape</button>
		<button class="preview-tape-btn" id="previewSurfaceBtn">Surface Selection</button>
		<button class="preview-tape-btn preview-exit-btn" id="exitPreviewBtn">Exit Preview</button>
	</div>

	<!-- PEEL button - bottom right in preview mode -->
	<button class="peel-btn" id="peelBtn">PEEL</button>
	<div class="peel-hint" id="peelHint">*Let PEEL button cooldown a few seconds before clicking again</div>

	<!-- Regular tape dropdown in preview mode -->
	<div class="regular-tape-dropdown" id="regularTapeDropdown">
		<h3>Select Regular Tape</h3>
		<div class="regular-tape-options" id="regularTapeOptions">
			<!-- Options populated by JavaScript -->
		</div>
	</div>

	<!-- Surface selection dropdown in preview mode -->
	<div class="surface-selection-dropdown" id="surfaceSelectionDropdown">
		<h3>Select Surface Material</h3>
		<div class="surface-selection-options" id="surfaceSelectionOptions">
			<!-- Options populated by JavaScript -->
		</div>
	</div>

	<!-- Floating tooltip shown above all content -->
	<div id="floatingTip" class="floating-tip" aria-hidden="true"></div>

	<script type="module" src="./display and css/desktop_size.js"></script>
	<script type="module" src="./display and css/tablet_size.js"></script>
	<script type="module" src="./display and css/phone_size.js"></script>

	<script type="module">
		// Import calculation functions
		import { calculateTapeProperties, getMaterialInfo, calculateMixedTapeProperties, calculateSurfaceDamageRisk, calculateTapeYellowTint, BACKING_MATERIALS, ADHESIVE_TYPES, SURFACE_MATERIALS, ENVIRONMENTAL_CONDITIONS, SURFACE_RUPTURE_STRENGTH } from './display and css/math_reasoning.js';
		
		// Make functions available globally
		window.calculateTapeProperties = calculateTapeProperties;
		window.getMaterialInfo = getMaterialInfo;
		window.calculateMixedTapeProperties = calculateMixedTapeProperties;
		window.calculateSurfaceDamageRisk = calculateSurfaceDamageRisk;
		window.calculateTapeYellowTint = calculateTapeYellowTint;
		window.BACKING_MATERIALS = BACKING_MATERIALS;
		window.ADHESIVE_TYPES = ADHESIVE_TYPES;
		window.SURFACE_MATERIALS = SURFACE_MATERIALS;
		window.ENVIRONMENTAL_CONDITIONS = ENVIRONMENTAL_CONDITIONS;
		window.SURFACE_RUPTURE_STRENGTH = SURFACE_RUPTURE_STRENGTH;
		
		// Signal that the module is loaded
		window.mathModuleLoaded = true;
		window.dispatchEvent(new Event('mathModuleReady'));
	</script>

	<script>
		// ==================== SECURITY FUNCTIONS ====================
		
		/**
		 * Sanitize HTML to prevent XSS attacks
		 * Escapes special characters that could be used for injection
		 */
		function sanitizeHTML(str) {
			if (typeof str !== 'string') return str;
			const div = document.createElement('div');
			div.textContent = str;
			return div.innerHTML;
		}
		
		/**
		 * Validate and sanitize numeric input
		 * Returns safe number within specified range
		 */
		function sanitizeNumber(value, min = -Infinity, max = Infinity, defaultValue = 0) {
			const num = Number(value);
			if (isNaN(num) || !isFinite(num)) return defaultValue;
			return Math.max(min, Math.min(max, num));
		}
		
		/**
		 * Validate string input against whitelist
		 * Returns value if valid, default otherwise
		 */
		function validateString(value, allowedValues, defaultValue) {
			if (typeof value !== 'string') return defaultValue;
			return allowedValues.includes(value) ? value : defaultValue;
		}
		
		/**
		 * Validate and sanitize localStorage data
		 * Checks structure and sanitizes all values
		 */
		function validateStateData(data) {
			if (!data || typeof data !== 'object') return null;
			
			// Validate params object
			if (data.params && typeof data.params === 'object') {
				data.params.width = sanitizeNumber(data.params.width, 1, 10000, 100);
				data.params.height = sanitizeNumber(data.params.height, 1, 10000, 80);
				data.params.thickness = sanitizeNumber(data.params.thickness, 1, 1000, 120);
				data.params.temperature = sanitizeNumber(data.params.temperature, -100, 200, 23);
				data.params.humidity = sanitizeNumber(data.params.humidity, 0, 100, 50);
				data.params.tapeLength = sanitizeNumber(data.params.tapeLength, 10, 100000, 1000);
			}
			
			// Validate arrays
			if (Array.isArray(data.history)) {
				data.history = data.history.slice(0, 1000); // Limit history size
			}
			if (Array.isArray(data.experiments)) {
				data.experiments = data.experiments.slice(0, 100); // Limit experiments
			}
			
			// Validate timeImpactDays
			if (typeof data.timeImpactDays === 'number') {
				data.timeImpactDays = sanitizeNumber(data.timeImpactDays, 0, 366, 0);
			}
			
			return data;
		}
		
		/**
		 * Safe JSON parse with error handling
		 */
		function safeJSONParse(str, defaultValue = null) {
			try {
				const parsed = JSON.parse(str);
				return validateStateData(parsed) || defaultValue;
			} catch (e) {
				console.warn('JSON parse failed:', e);
				return defaultValue;
			}
		}
		
		// ==================== END SECURITY FUNCTIONS ====================
		
		// UI State
		const state = {
			activePanel: 'dimensions',
			params: { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic', environment: 'Dry', tapeLength: 1000 },
			history: [],
			experiments: [],
			showGuidelines: false,
			materialPanel: { tape: false, surface: false },
			previewMode: false,
			timeImpactDays: 0,
			mixedTapes: { tape1: 'PVC', tape2: 'PP' }
		};

		const tapeOptions = ['PVC', 'Polypropylene', 'Cloth', 'Foam'];
		const surfaceOptions = ['Steel', 'Aluminum', 'Glass', 'Plastic'];

		// Load from localStorage
		function loadState() {
			try {
				const saved = localStorage.getItem('tape_ui_params');
				if (saved) {
					const parsed = safeJSONParse(saved);
					if (parsed && parsed.params) state.params = parsed.params;
				}
				const savedHistory = localStorage.getItem('tape_ui_history');
				if (savedHistory) {
					const parsed = safeJSONParse(savedHistory);
					if (Array.isArray(parsed)) {
						state.history = parsed.slice(0, 1000).map(entry => ({
							time: sanitizeHTML(entry.time || ''),
							text: sanitizeHTML(entry.text || '')
						}));
					}
				}
				const savedExperiments = localStorage.getItem('tape_ui_experiments');
				if (savedExperiments) {
					const parsed = safeJSONParse(savedExperiments);
					if (Array.isArray(parsed)) {
						state.experiments = parsed.slice(0, 100);
					}
				}
			} catch (e) {
				console.warn('Failed to load state:', e);
				// Reset to defaults on error
				state.params = { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic', environment: 'Dry', tapeLength: 1000 };
			}
		}

		// Save to localStorage
		function saveState() {
			try {
				localStorage.setItem('tape_ui_params', JSON.stringify(state.params));
				localStorage.setItem('tape_ui_history', JSON.stringify(state.history.slice(0, 50)));
				localStorage.setItem('tape_ui_experiments', JSON.stringify(state.experiments.slice(0, 100)));
			} catch (e) {
				console.warn('Failed to save state:', e);
			}
		}

		// Add history entry
		function addHistory(entry) {
			const time = new Date().toLocaleString();
			const sanitizedEntry = sanitizeHTML(String(entry));
			state.history.unshift({ time, text: sanitizedEntry });
			state.history = state.history.slice(0, 50);
			saveState();
		}

		// Render content based on active panel
		function renderContent() {
			const panel = document.getElementById('contentPanel');
			// Clear panel first so closing a panel removes its content immediately
			panel.innerHTML = '';
			const { width, height } = state.params;

			switch (state.activePanel) {
			case 'dimensions':
				// Get backing material info
				const backingInfo = window.getMaterialInfo('backing', state.params.tape) || {};
				const totalThickness = window.calculateTapeProperties ? 
					window.calculateTapeProperties(state.params).totalThickness : 
					(backingInfo.typicalThickness?.standard || 120);
				
				// Check if variant is being used
				const tape1 = state.mixedTapes.tape1;
				const tape2 = state.mixedTapes.tape2;
				const isVariant = tape1 && tape2;
				
				// Get tape length from state (default to 1000mm if not set)
				const tapeLength = state.params.tapeLength || 1000;
				
				panel.innerHTML = `
					<h2>Dimensions</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Sample dimensions and backing material specifications</p>
					
					${isVariant ? `
					<div style="margin-bottom: 20px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
						<div style="font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 1rem;">ðŸ”€ Variant Mode Active</div>
						<div style="font-size: 0.9rem; color: #78350f; line-height: 1.6;">
							<div style="margin-bottom: 4px;"><strong>Mixed Tapes:</strong> ${tape1} + ${tape2}</div>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #fcd34d;">
								<div>
									<div style="font-size: 0.85rem; color: #a16207; font-weight: 600; margin-bottom: 4px;">${tape1}</div>
									<div style="font-size: 0.8rem; line-height: 1.4;">
										Width: ${window.BACKING_MATERIALS?.[tape1]?.typicalThickness?.standard || 'N/A'} Âµm<br/>
										Common roll: 19mm Ã— 33m
									</div>
								</div>
								<div>
									<div style="font-size: 0.85rem; color: #a16207; font-weight: 600; margin-bottom: 4px;">${tape2}</div>
									<div style="font-size: 0.8rem; line-height: 1.4;">
										Width: ${window.BACKING_MATERIALS?.[tape2]?.typicalThickness?.standard || 'N/A'} Âµm<br/>
										Common roll: 19mm Ã— 33m
									</div>
								</div>
							</div>
						</div>
					</div>
					` : `
					<div style="margin-bottom: 16px; padding: 10px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 6px;">
						<div style="font-size: 0.85rem; color: #1e40af; font-weight: 600; margin-bottom: 4px;">Current Tape: ${state.params.tape}</div>
						<div style="font-size: 0.7rem; color: #6b7280; line-height: 1.4;">
							Backing thickness: ${backingInfo.typicalThickness?.standard || 'N/A'} Âµm<br/>
							Typical commercial dimensions: 19mm (width) Ã— 33m (length)
						</div>
					</div>
					`}
					
					<div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
						<div class="form-group">
							<label>Width (mm)</label>
							<input type="number" id="widthInput" value="${width}" min="1" step="0.5" />
						</div>
						<div class="form-group">
							<label>Height (mm)</label>
							<input type="number" id="heightInput" value="${height}" min="1" step="0.5" />
						</div>
						<div class="form-group">
							<label>Tape Length (mm)</label>
							<input type="number" id="tapeLengthInput" value="${tapeLength}" min="10" step="10" />
						</div>
					</div>
				`;
				document.getElementById('widthInput').addEventListener('change', (e) => {
					const sanitized = sanitizeNumber(e.target.value, 1, 10000, 100);
					state.params.width = sanitized;
					e.target.value = sanitized;
					addHistory(`Width set to ${sanitized}`);
					renderContent();
				});
				document.getElementById('heightInput').addEventListener('change', (e) => {
					const sanitized = sanitizeNumber(e.target.value, 1, 10000, 80);
					state.params.height = sanitized;
					e.target.value = sanitized;
					addHistory(`Height set to ${sanitized}`);
					renderContent();
				});
				document.getElementById('tapeLengthInput').addEventListener('change', (e) => {
					const sanitized = sanitizeNumber(e.target.value, 10, 100000, 1000);
					state.params.tapeLength = sanitized;
					e.target.value = sanitized;
					addHistory(`Tape length set to ${sanitized}mm`);
					renderContent();
				});
				break;			case 'specifics':
				// Check if variant is being used
				const specTape1 = state.mixedTapes.tape1;
				const specTape2 = state.mixedTapes.tape2;
				const isSpecVariant = specTape1 && specTape2;
				
				// Calculate tape properties using imported function
				const calculationParams = {
					...state.params,
					timeImpactDays: state.timeImpactDays || 0
				};
				
				// Use variant calculation if available, otherwise regular
				const props = isSpecVariant && window.calculateMixedTapeProperties ? 
					window.calculateMixedTapeProperties({
						tape1: specTape1,
						tape2: specTape2,
						surface: state.params.surface,
						adhesive: state.params.adhesive,
						environment: state.params.environment,
						thickness: state.params.thickness,
						timeImpactDays: state.timeImpactDays || 0
					}) : 
					(window.calculateTapeProperties ? 
						window.calculateTapeProperties(calculationParams) : 
						{ peel: '2.60', hold: '6.50', stretch: '25.0', totalThickness: 120 });
				
				// Get adhesive info
				const adhesiveInfo = window.getMaterialInfo ? 
					window.getMaterialInfo('adhesive', state.params.adhesive) : null;
				
				// Get surface info
				const surfaceInfo = window.getMaterialInfo ? 
					window.getMaterialInfo('surface', state.params.surface) : null;
				
				// Get environment info
				const envInfo = window.getMaterialInfo ? 
					window.getMaterialInfo('environment', state.params.environment) : null;
				
				// Calculate surface damage risk
				const damageRisk = window.calculateSurfaceDamageRisk ? 
					window.calculateSurfaceDamageRisk({
						...calculationParams,
						width: state.params.width,
						height: state.params.height
					}) : null;
				
				// Determine damage risk color scheme
				const damageColors = {
					'none': { bg: '#f0fdf4', border: '#86efac', text: '#166534' },
					'low': { bg: '#f0fdf4', border: '#86efac', text: '#166534' },
					'moderate': { bg: '#fffbeb', border: '#fde68a', text: '#92400e' },
					'high': { bg: '#fef2f2', border: '#fecaca', text: '#991b1b' },
					'critical': { bg: '#fef2f2', border: '#f87171', text: '#7f1d1d' }
				};
				const damageColor = damageColors[damageRisk?.damageRisk || 'none'];
				
				panel.innerHTML = `
					<h2>Specifics</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Adhesive properties and calculated performance metrics</p>
					
					${isSpecVariant ? `
					<div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
						<div style="font-weight: 600; color: #92400e; margin-bottom: 6px; font-size: 0.95rem;">ðŸ”€ Variant Tape Active</div>
						<div style="font-size: 0.85rem; color: #78350f;">
							Calculations based on composite of <strong>${specTape1}</strong> + <strong>${specTape2}</strong>
						</div>
					</div>
					` : ''}
					
					${damageRisk ? `
					<div style="margin-bottom: 16px; padding: 12px; background: ${damageColor.bg}; border: 2px solid ${damageColor.border}; border-radius: 8px;">
						<div style="font-weight: 600; color: ${damageColor.text}; margin-bottom: 6px; font-size: 0.9rem;">
							âš ï¸ Surface Damage Assessment
						</div>
						<div style="font-size: 0.85rem; color: ${damageColor.text}; line-height: 1.5;">
							${damageRisk.message}
						</div>
					</div>
					` : ''}
					
					<div class="form-grid">
						<div class="form-group">
							<label style="display: flex; align-items: center; gap: 8px;">
								Adhesive Thickness (Âµm)
								<span style="font-size: 0.75rem; color: #6b7280; font-weight: 400;">(affects contact area)</span>
							</label>
							<input type="number" id="thicknessInput" value="${state.params.thickness}" min="10" max="500" step="5" />
						</div>
						<div class="form-group">
							<label>Adhesive Type</label>
							<select id="adhesiveSelect">
								<option ${state.params.adhesive === 'Acrylic' ? 'selected' : ''}>Acrylic</option>
								<option ${state.params.adhesive === 'Rubber' ? 'selected' : ''}>Rubber</option>
								<option ${state.params.adhesive === 'Silicone' ? 'selected' : ''}>Silicone</option>
							</select>
						</div>
					</div>
					
					${adhesiveInfo ? `
					<div style="margin-top: 16px; padding: 14px; background: #fffbeb; border: 2px solid #fde68a; border-radius: 8px;">
						<h3 style="margin: 0 0 8px 0; font-size: 0.9rem; color: #92400e; font-weight: 600;">Adhesive: ${adhesiveInfo.name}</h3>
						<div style="font-size: 0.8rem; line-height: 1.6; color: #78350f;">
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
								<div style="padding: 4px 0;"><strong>Tack:</strong> ${adhesiveInfo.tackLevel || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>UV:</strong> ${adhesiveInfo.uvResistance || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>Aging:</strong> ${adhesiveInfo.agingStability || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>Temp:</strong> ${adhesiveInfo.temperatureRange?.min || 0}Â°C to ${adhesiveInfo.temperatureRange?.max || 0}Â°C</div>
							</div>
							<p style="margin: 4px 0 0 0; font-size: 0.75rem; font-style: italic;">${adhesiveInfo.description || ''}</p>
						</div>
					</div>
					` : ''}
					
					<div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px;">
						<h3 style="margin: 0 0 12px 0; font-size: 1rem; color: #166534; font-weight: 600;">Calculated Performance</h3>
						<div style="display: flex; flex-direction: column; gap: 10px;">
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Peel Adhesion:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.peel} N/cm</span>
							</div>
							<div style="font-size: 0.75rem; color: #166534; margin: -6px 0; padding: 0 12px;">
								Force needed to peel the tape off at 90Â° angle. Higher = stronger bond to surface.
								${damageRisk && damageRisk.canDamage ? `<br><strong>Surface impact:</strong> ${damageRisk.damageRisk === 'low' ? 'âœ“ Safe for this surface' : damageRisk.damageRisk === 'moderate' ? 'âš  Use with caution' : 'âš  High risk of damage'}` : ''}
							</div>
							
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Shear/Hold Strength:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.hold} N/cmÂ²</span>
							</div>
							<div style="font-size: 0.75rem; color: #166534; margin: -6px 0; padding: 0 12px;">
								Resistance to sliding under load. Critical for vertical applications and weight bearing.
								${damageRisk && damageRisk.canDamage ? `<br><strong>Surface impact:</strong> Tape force ${damageRisk.tapeForce.toFixed(2)} N/cm vs surface strength ${damageRisk.surfaceStrength.toFixed(1)} N/cm` : damageRisk && !damageRisk.canDamage ? `<br><strong>Surface impact:</strong> Surface is too strong to damage (${damageRisk.tapeForce.toFixed(2)} N/cm tape force)` : ''}
							</div>
							
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Elongation at Break:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.stretch}%</span>
							</div>
							<div style="font-size: 0.75rem; color: #166534; margin: -6px 0; padding: 0 12px;">
								How much the tape can stretch before breaking. Lower = more rigid, higher = more flexible.
								${damageRisk && damageRisk.canDamage && damageRisk.surfaceRange ? `<br><strong>Surface impact:</strong> Surface tears at ${damageRisk.surfaceRange.min}-${damageRisk.surfaceRange.max} N/cm` : ''}
							</div>
							
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #dcfce7; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Total Thickness:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.totalThickness} Âµm</span>
							</div>
						<div style="font-size: 0.75rem; color: #166534; margin: -6px 0; padding: 0 12px;">
							Combined thickness of backing + adhesive${isSpecVariant ? ' (both tape layers)' : ''}. Affects conformability and gap filling.
						</div>
						<div style="font-size: 0.7rem; color: #059669; margin: 8px 0 0 0; padding: 6px 12px; background: #d1fae5; border-left: 3px solid #10b981; border-radius: 4px; line-height: 1.4;">
							ðŸ’¡ <strong>Adhesive thickness impact:</strong> Thicker adhesive layer â†’ stronger adhesion â†’ higher peel force â†’ greater risk to delicate surfaces like veneer or paint.
						</div>
					</div>
				</div>					<div style="margin-top: 16px; padding: 14px; background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px;">
						<h3 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #1e40af; font-weight: 600;">ðŸ“Š Current Test Conditions</h3>
						<div style="font-size: 0.85rem; line-height: 1.7; color: #1e40af;">
							<div style="margin-bottom: 8px;">
								<strong>Tape:</strong> ${isSpecVariant ? `${specTape1} + ${specTape2} (Variant)` : state.params.tape}
							</div>
							<div style="margin-bottom: 8px;">
								<strong>Surface:</strong> ${state.params.surface}
								${surfaceInfo ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">${surfaceInfo.description}</div>` : ''}
							</div>
							<div style="margin-bottom: 8px;">
								<strong>Environment:</strong> ${state.params.environment}
								${envInfo ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">${envInfo.description}</div>` : ''}
							</div>
							<div>
								<strong>Adhesive:</strong> ${state.params.adhesive} (${state.params.thickness}Âµm layer)
							</div>
						</div>
						<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bfdbfe; font-size: 0.8rem; color: #1e40af; font-style: italic;">
							${isSpecVariant ? 
								`The variant tape combines properties of both ${specTape1} and ${specTape2}, with the ${state.params.adhesive} adhesive bonding to the ${state.params.surface} surface. Performance is influenced by ${state.params.environment} environmental conditions.` :
								`This ${state.params.tape} tape with ${state.params.adhesive} adhesive is tested on ${state.params.surface} surface under ${state.params.environment} conditions. Values reflect real-world expected performance.`
							}
						</div>
					</div>
				`;
				
				// Add event listeners to update parameters and recalculate
				const thicknessInput = document.getElementById('thicknessInput');
				const adhesiveSelect = document.getElementById('adhesiveSelect');
				
				thicknessInput.addEventListener('change', (e) => {
					const sanitized = sanitizeNumber(e.target.value, 1, 1000, 120);
					state.params.thickness = sanitized;
					e.target.value = sanitized;
					saveState();
					renderContent('specifics');
				});
				
				adhesiveSelect.addEventListener('change', (e) => {
					const allowedAdhesives = ['Acrylic', 'Rubber', 'Silicone'];
					state.params.adhesive = validateString(e.target.value, allowedAdhesives, 'Acrylic');
					saveState();
					renderContent('specifics');
if (state.previewMode) updateTapeYellowTint();
				});
				break;			case 'environment':
				// Get environment data from imported module
				const envConditions = window.ENVIRONMENTAL_CONDITIONS || {
					'Humid': { name: 'Humid', temperature: { min: 15, max: 25 }, humidity: { min: 70, max: 90 }, description: 'High moisture', adhesionMultiplier: 0.75 },
					'Tropical': { name: 'Tropical', temperature: { min: 25, max: 35 }, humidity: { min: 75, max: 95 }, description: 'Hot & humid', adhesionMultiplier: 0.65 },
					'Semiarid': { name: 'Semiarid', temperature: { min: 20, max: 30 }, humidity: { min: 30, max: 50 }, description: 'Balanced', adhesionMultiplier: 0.95 },
					'Arid': { name: 'Arid', temperature: { min: 25, max: 40 }, humidity: { min: 10, max: 30 }, description: 'Hot & dry', adhesionMultiplier: 0.85 },
					'Dry': { name: 'Dry', temperature: { min: 18, max: 25 }, humidity: { min: 20, max: 40 }, description: 'Ideal', adhesionMultiplier: 1.0 }
				};
				
				const currentEnv = envConditions[state.params.environment] || envConditions['Dry'];
				
				panel.innerHTML = `
					<h2>Environment</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Climate conditions affect adhesive performance significantly</p>
					<div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">
						${['Humid', 'Tropical', 'Semiarid', 'Arid', 'Dry'].map(env => {
							const envInfo = envConditions[env];
							const isSelected = state.params.environment === env;
							const performanceClass = envInfo.adhesionMultiplier >= 0.95 ? 'excellent' : 
													 envInfo.adhesionMultiplier >= 0.80 ? 'good' : 
													 envInfo.adhesionMultiplier >= 0.70 ? 'fair' : 'poor';
							const performanceColor = performanceClass === 'excellent' ? '#10b981' : 
													 performanceClass === 'good' ? '#3b82f6' : 
													 performanceClass === 'fair' ? '#f59e0b' : '#ef4444';
							return `
							<div class="environment-choice ${isSelected ? 'selected' : ''}" 
								 data-env="${env}"
								 style="border: 2px solid ${isSelected ? '#2563eb' : '#d1d5db'}; 
										border-radius: 6px; 
										padding: 12px 16px; 
										background: ${isSelected ? '#eff6ff' : '#fff'}; 
										cursor: pointer;
										transition: all 0.2s ease;">
								<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
									<span style="font-weight: ${isSelected ? '600' : '500'}; color: #1f2937;">â€¢ ${envInfo.name || env}</span>
									<span style="font-size: 0.7rem; padding: 2px 8px; background: ${performanceColor}; color: #fff; border-radius: 12px; text-transform: uppercase; font-weight: 600;">${performanceClass}</span>
								</div>
								<div style="display: flex; gap: 16px; font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">
									<span>ðŸŒ¡ï¸ ${envInfo.temperature.min}-${envInfo.temperature.max}Â°C</span>
									<span>ðŸ’§ ${envInfo.humidity.min}-${envInfo.humidity.max}%</span>
								</div>
								<div style="font-size: 0.75rem; color: #9ca3af; font-style: italic;">${envInfo.description || ''}</div>
							</div>
						`}).join('')}
					</div>
					
					<div style="margin-top: 20px; padding: 14px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
						<h3 style="margin: 0 0 8px 0; font-size: 0.9rem; color: #92400e; font-weight: 600;">Current: ${currentEnv.name || state.params.environment}</h3>
						<div style="font-size: 0.8rem; line-height: 1.7; color: #78350f;">
							<div style="margin-bottom: 6px;"><strong>Adhesion Factor:</strong> ${(currentEnv.adhesionMultiplier * 100).toFixed(0)}% of baseline</div>
							<div style="margin-bottom: 6px;"><strong>Aging Rate:</strong> ${currentEnv.agingFactor ? (currentEnv.agingFactor * 100).toFixed(0) + '% of normal' : 'Standard'}</div>
							<p style="margin: 8px 0 0 0; font-size: 0.75rem; font-style: italic; border-top: 1px solid #fcd34d; padding-top: 8px;">${currentEnv.description || 'Environmental conditions impact adhesive tack, wet-out, and long-term stability.'}</p>
						</div>
					</div>
				`;
				
				// Add click handlers for environment choices
				document.querySelectorAll('.environment-choice').forEach(choice => {
				choice.addEventListener('click', () => {
					const env = choice.getAttribute('data-env');
					state.params.environment = env;
					updatePlaygroundBackground(env);
					saveState();
					renderContent('environment');
					// Update yellow tint in preview mode
					if (state.previewMode) {
						updateTapeYellowTint();
					}
				});					choice.addEventListener('mouseenter', function() {
						if (state.params.environment !== this.getAttribute('data-env')) {
							this.style.background = '#f3f4f6';
							this.style.borderColor = '#9ca3af';
						}
					});
					
					choice.addEventListener('mouseleave', function() {
						if (state.params.environment !== this.getAttribute('data-env')) {
							this.style.background = '#fff';
							this.style.borderColor = '#d1d5db';
						}
					});
				});
				break;
			case 'history':
				panel.innerHTML = `
					<h2>Saved Experiments</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Complete record of all saved tape tests and configurations</p>
					${state.experiments.length === 0 ? '<div style="color: #6b7280; padding: 20px; text-align: center; border: 2px dashed #e5e7eb; border-radius: 8px;">No experiments saved yet. Click the "Save Experiment" button to record your current configuration.</div>' : `
						<div style="display: flex; flex-direction: column; gap: 16px;">
							${state.experiments.map((exp, idx) => {
								const isVariant = exp.variant?.isVariant || false;
								const tapeLength = exp.data.tapeLength || 1000;
								return `
								<div style="border: 2px solid ${isVariant ? '#fbbf24' : '#bfdbfe'}; border-radius: 8px; padding: 16px; background: ${isVariant ? '#fefce8' : '#f0f9ff'};">
									<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
										<div style="font-weight: 600; font-size: 1rem; color: ${isVariant ? '#92400e' : '#1e40af'};">${exp.name}</div>
										${isVariant ? '<div style="background: #fbbf24; color: #fff; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">VARIANT</div>' : ''}
									</div>
									
									${isVariant ? `
									<div style="margin-bottom: 12px; padding: 10px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
										<div style="font-size: 0.85rem; color: #92400e; font-weight: 600; margin-bottom: 4px;">ðŸ”€ Mixed Tape Composition</div>
										<div style="font-size: 0.8rem; color: #78350f;">
											<strong>${exp.variant.tape1}</strong> + <strong>${exp.variant.tape2}</strong>
										</div>
									</div>
									` : ''}
									
									<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.85rem; color: #4b5563; line-height: 1.7;">
										<div>
											<div style="font-weight: 600; color: #1f2937; margin-bottom: 6px; font-size: 0.9rem;">ðŸ“ Dimensions</div>
											<div><strong>Width:</strong> ${exp.data.width} mm</div>
											<div><strong>Height:</strong> ${exp.data.height} mm</div>
											<div><strong>Tape Length:</strong> ${tapeLength} mm</div>
										</div>
										
										<div>
											<div style="font-weight: 600; color: #1f2937; margin-bottom: 6px; font-size: 0.9rem;">ðŸ”¬ Specifics</div>
											<div><strong>Adhesive:</strong> ${exp.data.adhesive}</div>
											<div><strong>Thickness:</strong> ${exp.data.thickness} Âµm</div>
											${!isVariant ? `<div><strong>Backing:</strong> ${exp.data.tape}</div>` : ''}
										</div>
										
										<div>
											<div style="font-weight: 600; color: #1f2937; margin-bottom: 6px; font-size: 0.9rem;">ðŸŽ¯ Test Surface</div>
											<div style="color: #6b7280;">${exp.data.surface}</div>
										</div>
										
										<div>
											<div style="font-weight: 600; color: #1f2937; margin-bottom: 6px; font-size: 0.9rem;">ðŸŒ¡ï¸ Environment</div>
											<div style="color: #6b7280;">${exp.data.environment || 'Dry'}</div>
										</div>
									</div>
									
									<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ${isVariant ? '#fde68a' : '#bfdbfe'}; font-size: 0.75rem; color: #9ca3af;">
										<strong>Saved:</strong> ${exp.timestamp}
									</div>
								</div>
							`}).join('')}
						</div>
					`}
				`;
				break;
			case 'variant':
				const varTape1 = state.mixedTapes.tape1;
				const varTape2 = state.mixedTapes.tape2;
				
				if (!varTape1 || !varTape2) {
					panel.innerHTML = `
						<h2>Tape Variant</h2>
						<p style="color: #6b7280; font-size: 0.95rem;">Select two tape types from the "Tape Material" button in the bottom bar to see mixed properties.</p>
					`;
				} else {
					// Calculate mixed properties
					const mixedProps = window.calculateMixedTapeProperties ? 
						window.calculateMixedTapeProperties({
							tape1: varTape1,
							tape2: varTape2,
							surface: state.params.surface,
							adhesive: state.params.adhesive,
							environment: state.params.environment,
							thickness: state.params.thickness,
							timeImpactDays: state.timeImpactDays
						}) : { peel: 'N/A', hold: 'N/A', stretch: 'N/A', totalThickness: 'N/A' };
					
					// Get environment info
					const varEnvInfo = window.ENVIRONMENTAL_CONDITIONS?.[state.params.environment] || {};
					
					// Calculate surface risks for all surfaces
					const surfaces = ['Paper Note', 'Manga Paper', 'Sketchbook Paper', 'Photo', 'Rough Carton', 'Door Veneer', 'Wall Paint', 'Damaged Wall Paint', 'Steel', 'Aluminum', 'Glass', 'Textured Glass', 'Plastic Bag'];
					const surfaceRisks = surfaces.map(surf => {
						const risk = window.calculateSurfaceDamageRisk ? 
							window.calculateSurfaceDamageRisk({
								...state.params,
								tape1: varTape1,
								tape2: varTape2,
								surface: surf,
								width: state.params.width,
								height: state.params.height
							}) : null;
						return { surface: surf, risk };
					}).filter(item => item.risk);
					
					// Group by risk level
					const criticalSurfaces = surfaceRisks.filter(s => s.risk.damageRisk === 'critical');
					const highSurfaces = surfaceRisks.filter(s => s.risk.damageRisk === 'high');
					const moderateSurfaces = surfaceRisks.filter(s => s.risk.damageRisk === 'moderate');
					const lowSurfaces = surfaceRisks.filter(s => s.risk.damageRisk === 'low');
					const safeSurfaces = surfaceRisks.filter(s => !s.risk.canDamage);
					
					panel.innerHTML = `
						<h2>Variant Tape Analysis</h2>
						<p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 16px;">Composite: ${varTape1} + ${varTape2}</p>
						
						<div style="background: #eff6ff; border: 2px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
							<h3 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #1e40af;">ðŸ“Š Current Configuration</h3>
							<div style="font-size: 0.8rem; line-height: 1.7; color: #1e3a8a;">
								<div><strong>Dimensions:</strong> ${state.params.width}Ã—${state.params.height}mm, ${state.params.tapeLength || 1000}mm length</div>
								<div><strong>Adhesive:</strong> ${state.params.adhesive}, ${state.params.thickness}Âµm thick</div>
								<div><strong>Environment:</strong> ${state.params.environment} (${varEnvInfo.temperature?.typical || 20}Â°C, ${varEnvInfo.humidity?.typical || 50}% RH)</div>
							</div>
						</div>
						
						<div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
							<h3 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #92400e;">âš¡ Performance Metrics</h3>
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
								<div style="padding: 6px 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
									<div style="color: #78350f;">Peel</div>
									<strong>${mixedProps.peel} N/cm</strong>
								</div>
								<div style="padding: 6px 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
									<div style="color: #78350f;">Hold</div>
									<strong>${mixedProps.hold} N/cmÂ²</strong>
								</div>
								<div style="padding: 6px 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
									<div style="color: #78350f;">Stretch</div>
									<strong>${mixedProps.stretch}%</strong>
								</div>
								<div style="padding: 6px 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
									<div style="color: #78350f;">Thickness</div>
									<strong>${mixedProps.totalThickness} Âµm</strong>
								</div>
							</div>
						</div>
						
						<div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px;">
							<h3 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #1f2937;">âš ï¸ Surface Damage Risk Analysis</h3>
							
							${criticalSurfaces.length > 0 ? `
							<div style="margin-bottom: 10px; padding: 8px; background: #fef2f2; border-left: 3px solid #f87171; border-radius: 4px;">
								<div style="font-size: 0.75rem; font-weight: 600; color: #991b1b; margin-bottom: 4px;">ðŸ”´ CRITICAL</div>
								<div style="font-size: 0.7rem; color: #7f1d1d;">${criticalSurfaces.map(s => s.surface).join(', ')}</div>
							</div>` : ''}
							
							${highSurfaces.length > 0 ? `
							<div style="margin-bottom: 10px; padding: 8px; background: #fef2f2; border-left: 3px solid #fca5a5; border-radius: 4px;">
								<div style="font-size: 0.75rem; font-weight: 600; color: #991b1b; margin-bottom: 4px;">ðŸŸ  HIGH RISK</div>
								<div style="font-size: 0.7rem; color: #7f1d1d;">${highSurfaces.map(s => s.surface).join(', ')}</div>
							</div>` : ''}
							
							${moderateSurfaces.length > 0 ? `
							<div style="margin-bottom: 10px; padding: 8px; background: #fffbeb; border-left: 3px solid #fbbf24; border-radius: 4px;">
								<div style="font-size: 0.75rem; font-weight: 600; color: #92400e; margin-bottom: 4px;">ðŸŸ¡ MODERATE</div>
								<div style="font-size: 0.7rem; color: #78350f;">${moderateSurfaces.map(s => s.surface).join(', ')}</div>
							</div>` : ''}
							
							${lowSurfaces.length > 0 ? `
							<div style="margin-bottom: 10px; padding: 8px; background: #f0fdf4; border-left: 3px solid #86efac; border-radius: 4px;">
								<div style="font-size: 0.75rem; font-weight: 600; color: #166534; margin-bottom: 4px;">ðŸŸ¢ LOW RISK</div>
								<div style="font-size: 0.7rem; color: #15803d;">${lowSurfaces.map(s => s.surface).join(', ')}</div>
							</div>` : ''}
							
							${safeSurfaces.length > 0 ? `
							<div style="padding: 8px; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px;">
								<div style="font-size: 0.75rem; font-weight: 600; color: #166534; margin-bottom: 4px;">âœ… SAFE</div>
								<div style="font-size: 0.7rem; color: #15803d;">${safeSurfaces.map(s => s.surface).join(', ')} - Tape fails before surface</div>
							</div>` : ''}
						</div>
					`;
				}
				break;
			}
			// Add guidelines if active
			if (state.showGuidelines && state.activePanel !== 'history') {
				panel.innerHTML += `
					<div class="guidelines-box">
						<h3>Guidelines</h3>
						<p style="font-size: 0.9rem; line-height: 1.6; margin: 0 0 12px 0;">
							This is a locally made website with the help of AI and simple maths. To simulate real-world situations, environment behaviour, tape stickiness, tape strength, after-peel damage of new/existing tape variants. This is specifically made as a testing playground for my first Product UX RDI (research/design/innovation) case.
						</p>
						<p style="font-size: 0.9rem; line-height: 1.6; margin: 0;">
							For More visit the LinkedIn page where I post the structured presentation on my research (coming soon on 17-11-25)
						</p>
				</div>
				<div class="qr-code show">
					<img src="./images/LinkedIn_QR.png" alt="" />
				</div>
			`;
						} else {
				// Hide QR code when guidelines are not shown
			}
		}

		// Sidebar button handlers (click to open, click again to close)
		document.querySelectorAll('.sidebar-btn[data-panel], .save-btn[data-panel]').forEach(btn => {
			btn.addEventListener('click', (e) => {
				e.stopPropagation();
				const panelName = btn.getAttribute('data-panel');

				// Special case: save
				if (panelName === 'save') {
					const experimentNum = state.experiments.length + 1;
					const timestamp = new Date().toLocaleString();
					const experimentName = `Tape Experiment ${experimentNum} - ${timestamp}`;
					const snapshot = {
						id: experimentNum,
						name: experimentName,
						timestamp: timestamp,
						data: { ...state.params },
						variant: {
							isVariant: !!(state.mixedTapes.tape1 && state.mixedTapes.tape2),
							tape1: state.mixedTapes.tape1,
							tape2: state.mixedTapes.tape2
						}
					};
					state.experiments.push(snapshot);
					addHistory(`Saved experiment: ${experimentName}`);
					saveState();
					
					// Show save indicator
					const saveNotice = document.getElementById('saveNotice');
					saveNotice.textContent = `âœ“ Experiment ${experimentNum} Saved`;
					saveNotice.classList.add('show');
					setTimeout(() => saveNotice.classList.remove('show'), 2500);
					
					// If history panel is open, refresh it
					if (state.activePanel === 'history') {
						renderContent('history');
					}
					return;
				}

				// Toggle behavior: if clicking the already-open panel, close it
				if (state.activePanel === panelName) {
					state.activePanel = null;
					state.showGuidelines = false;
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					document.getElementById('contentPanel').innerHTML = '';
					addHistory(`Closed ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
					return;
				}

				// Guidelines toggles the guidelines overlay within the panel
				if (panelName === 'guidelines') {
					state.showGuidelines = true;
					state.activePanel = 'guidelines';
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					renderContent();
					addHistory('Opened Guidelines');
					return;
				}

				// Open a new panel
				state.activePanel = panelName;
				state.showGuidelines = false;
				document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				renderContent();
				addHistory(`Opened ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
			});
		});

		// Reset button
		document.getElementById('resetBtn').addEventListener('click', () => {
			state.params = { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic' };
			state.history = [];
			state.experiments = [];
			state.activePanel = 'dimensions';
			state.showGuidelines = false;
			state.materialPanel = { tape: false, surface: false };
			localStorage.clear();
			location.reload();
		});

		// Material popup windows with pills (tape) and grid tiles (surface)
		const tapePopup = document.getElementById('tapePopup');
		const surfacePopup = document.getElementById('surfacePopup');
		const tapePillsContainer1 = document.getElementById('tapePills1');
		const tapePillsContainer2 = document.getElementById('tapePills2');
		const surfaceGridContainer = document.getElementById('surfaceGrid');

		// Extended tape options
		const tapeMaterials = [
			{ name: 'PVC', display: 'PVC (Polyvinyl Chloride)', image: './images/tape_types/PVC_tape.png' },
			{ name: 'PET', display: 'PET (Polyester Film)', image: './images/tape_types/PET_tape.png' },
			{ name: 'PP', display: 'PP (Polypropylene)', image: './images/tape_types/PP_tape.png' },
			{ name: 'BOPP', display: 'BOPP (Biaxially Oriented Polypropylene)', image: './images/tape_types/BOPP_tape.png' },
			{ name: 'Paper', display: 'Paper Tape', image: './images/tape_types/Paper_tape.png' },
			{ name: 'Cloth', display: 'Cloth / Fabric', image: './images/tape_types/Cloth_tape.png' },
			{ name: 'Foam', display: 'Foam / Cushion', image: './images/tape_types/Foam_tape.png' }
		];

		// Surface materials with texture images
		const surfaceMaterials = [
			{ name: 'Steel', label: 'Steel', image: './images/textures/steel.jpeg' },
			{ name: 'Aluminum', label: 'Aluminum', image: './images/textures/aluminum.jpeg' },
			{ name: 'Glass', label: 'Glass', image: './images/textures/glass.png' },
			{ name: 'Textured Glass', label: 'Textured Glass', image: './images/textures/textured_glass.png' },
			{ name: 'Plastic Bag', label: 'Plastic Bag', image: './images/textures/plastic_bag.jpeg' },
			{ name: 'Door Veneer', label: 'Door Veneer', image: './images/textures/door_veneer.jpeg' },
			{ name: 'Paper Note', label: 'Paper Note', image: './images/textures/paper_note.png' },
			{ name: 'Manga Paper', label: 'Manga Paper', image: './images/textures/manga_paper.jpeg' },
			{ name: 'Sketchbook Paper', label: 'Sketchbook Paper', image: './images/textures/sketchbook_paper.jpeg' },
			{ name: 'Rough Carton', label: 'Rough Carton', image: './images/textures/rough_carton.jpeg' },
			{ name: 'Wall Paint', label: 'Wall Paint', image: './images/textures/wall_paint.jpeg' },
			{ name: 'Damaged Wall Paint', label: 'Damaged Wall Paint', image: './images/textures/damaged_wall_paint.jpeg' },
			{ name: 'Photo', label: 'Photo', image: './images/textures/photo.png' }
		];

		// Pre-configured regular tape options with fixed properties
		const regularTapeOptions = [
			{ 
				name: 'Standard Packing Tape', 
				backing: 'PP', 
				adhesive: 'Acrylic',
				thickness: 50,
				width: 48,
				specs: 'PP backing, Acrylic adhesive, 50Âµm thick, 48mm wide'
			},
			{ 
				name: 'Heavy Duty Packing', 
				backing: 'BOPP', 
				adhesive: 'Rubber',
				thickness: 65,
				width: 50,
				specs: 'BOPP backing, Rubber adhesive, 65Âµm thick, 50mm wide'
			},
			{ 
				name: 'Clear Office Tape', 
				backing: 'BOPP', 
				adhesive: 'Acrylic',
				thickness: 40,
				width: 19,
				specs: 'BOPP backing, Acrylic adhesive, 40Âµm thick, 19mm wide'
			},
			{ 
				name: 'Masking Tape', 
				backing: 'Paper', 
				adhesive: 'Rubber',
				thickness: 130,
				width: 24,
				specs: 'Paper backing, Rubber adhesive, 130Âµm thick, 24mm wide'
			},
			{ 
				name: 'Duct Tape', 
				backing: 'Cloth', 
				adhesive: 'Rubber',
				thickness: 280,
				width: 48,
				specs: 'Cloth backing, Rubber adhesive, 280Âµm thick, 48mm wide'
			},
			{ 
				name: 'Double-Sided Foam', 
				backing: 'Foam', 
				adhesive: 'Acrylic',
				thickness: 800,
				width: 12,
				specs: 'Foam backing, Acrylic adhesive, 800Âµm thick, 12mm wide'
			},
			{ 
				name: 'Premium PVC Electrical', 
				backing: 'PVC', 
				adhesive: 'Rubber',
				thickness: 180,
				width: 19,
				specs: 'PVC backing, Rubber adhesive, 180Âµm thick, 19mm wide'
			}
		];

		// State for selected regular tape
		state.selectedRegularTape = null;

		// Populate tape pills - Column 1
		tapeMaterials.forEach(mat => {
			const pill = document.createElement('div');
			pill.className = 'material-pill';
			if (mat.name === state.mixedTapes.tape1) pill.classList.add('selected');
			pill.textContent = mat.display;
			pill.addEventListener('click', () => {
				state.mixedTapes.tape1 = mat.name;
				addHistory(`Tape 1 selected: ${mat.name}`);
				updatePillSelection();
				renderContent();
				// Update preview tape images if in preview mode with variant button active
				if (state.previewMode && document.getElementById('variantTapeBtn').classList.contains('active')) {
					updatePreviewTapeImages();
				}
			});
			tapePillsContainer1.appendChild(pill);
		});

		// Populate tape pills - Column 2
		tapeMaterials.forEach(mat => {
			const pill = document.createElement('div');
			pill.className = 'material-pill';
			if (mat.name === state.mixedTapes.tape2) pill.classList.add('selected');
			pill.textContent = mat.display;
			pill.addEventListener('click', () => {
				state.mixedTapes.tape2 = mat.name;
				addHistory(`Tape 2 selected: ${mat.name}`);
				updatePillSelection();
				renderContent();
				// Update preview tape images if in preview mode with variant button active
				if (state.previewMode && document.getElementById('variantTapeBtn').classList.contains('active')) {
					updatePreviewTapeImages();
				}
			});
			tapePillsContainer2.appendChild(pill);
		});

		// Populate surface tiles
		surfaceMaterials.forEach(mat => {
			const wrap = document.createElement('div');
			wrap.className = 'material-tile-wrap';
			
			const tile = document.createElement('div');
			tile.className = 'material-tile';
			if (mat.name === state.params.surface) tile.classList.add('selected');
			
			const img = document.createElement('img');
			img.src = mat.image;
			img.alt = mat.label;
			tile.appendChild(img);
			
			const label = document.createElement('div');
			label.className = 'material-tile-label';
			label.textContent = mat.label;
			
			wrap.appendChild(tile);
			wrap.appendChild(label);
			
			wrap.addEventListener('click', () => {
				state.params.surface = mat.name;
				addHistory(`Surface selected: ${mat.name}`);
				updateTileSelection();
				closeSurfacePopup();
				renderContent();
				// Update preview surface image if in preview mode
				if (state.previewMode) {
					updatePreviewSurfaceImage();
				}
			});
			
			surfaceGridContainer.appendChild(wrap);
		});

		// Populate regular tape dropdown options
		const regularTapeOptionsContainer = document.getElementById('regularTapeOptions');
		regularTapeOptions.forEach(tape => {
			const option = document.createElement('div');
			option.className = 'regular-tape-option';
			if (state.selectedRegularTape === tape.name) option.classList.add('selected');
			
			const name = document.createElement('div');
			name.className = 'tape-name';
			name.textContent = tape.name;
			
			const specs = document.createElement('div');
			specs.className = 'tape-specs';
			specs.textContent = tape.specs;
			
			option.appendChild(name);
			option.appendChild(specs);
			
			option.addEventListener('click', () => {
				state.selectedRegularTape = tape.name;
				updateRegularTapeSelection();
				updatePreviewRegularTapeImage();
				addHistory(`Regular tape selected: ${tape.name}`);
			});
			
			regularTapeOptionsContainer.appendChild(option);
		});

		function updateRegularTapeSelection() {
			document.querySelectorAll('.regular-tape-option').forEach(opt => {
				opt.classList.remove('selected');
			});
			regularTapeOptions.forEach((tape, index) => {
				if (tape.name === state.selectedRegularTape) {
					document.querySelectorAll('.regular-tape-option')[index].classList.add('selected');
				}
			});
		}

		// Populate surface selection dropdown
		const surfaceSelectionOptionsContainer = document.getElementById('surfaceSelectionOptions');
		surfaceMaterials.forEach(surface => {
			const option = document.createElement('div');
			option.className = 'surface-selection-option';
			
			const name = document.createElement('span');
			name.textContent = surface.label;
			name.style.fontWeight = 'bold';
			
			option.appendChild(name);
			
			option.addEventListener('click', () => {
				state.params.surface = surface.name;
				updateSurfaceSelectionDropdown();
				updatePreviewSurfaceImage();
				addHistory(`Surface material selected: ${surface.label}`);
			});
			
			surfaceSelectionOptionsContainer.appendChild(option);
		});

		function updateSurfaceSelectionDropdown() {
			document.querySelectorAll('.surface-selection-option').forEach(opt => {
				opt.classList.remove('selected');
			});
			surfaceMaterials.forEach((surface, index) => {
				if (surface.name === state.params.surface) {
					document.querySelectorAll('.surface-selection-option')[index].classList.add('selected');
				}
			});
		}

		function updatePillSelection() {
			// Update column 1
			const pills1 = tapePillsContainer1.querySelectorAll('.material-pill');
			pills1.forEach((pill, index) => {
				pill.classList.remove('selected');
				if (tapeMaterials[index].name === state.mixedTapes.tape1) {
					pill.classList.add('selected');
				}
			});
			
			// Update column 2
			const pills2 = tapePillsContainer2.querySelectorAll('.material-pill');
			pills2.forEach((pill, index) => {
				pill.classList.remove('selected');
				if (tapeMaterials[index].name === state.mixedTapes.tape2) {
					pill.classList.add('selected');
				}
			});
		}

		function updateTileSelection() {
			document.querySelectorAll('.material-tile').forEach(tile => {
				tile.classList.remove('selected');
			});
			const tiles = Array.from(document.querySelectorAll('.material-tile-wrap'));
			const selectedTile = tiles.find(wrap => {
				const label = wrap.querySelector('.material-tile-label').textContent;
				const mat = surfaceMaterials.find(m => m.label === label);
				return mat && mat.name === state.params.surface;
			});
			if (selectedTile) selectedTile.querySelector('.material-tile').classList.add('selected');
		}

		// Popup control functions
		function openTapePopup() {
			tapePopup.classList.add('open');
			closeSurfacePopup();
		}

		function closeTapePopup() {
			tapePopup.classList.remove('open');
		}

		function toggleTapePopup() {
			tapePopup.classList.contains('open') ? closeTapePopup() : openTapePopup();
		}

		function openSurfacePopup() {
			surfacePopup.classList.add('open');
			closeTapePopup();
		}

		function closeSurfacePopup() {
			surfacePopup.classList.remove('open');
		}

		function toggleSurfacePopup() {
			surfacePopup.classList.contains('open') ? closeSurfacePopup() : openSurfacePopup();
		}

		// Button event listeners
		document.getElementById('tapeMaterialBtn').addEventListener('click', toggleTapePopup);
		document.getElementById('surfaceMaterialBtn').addEventListener('click', toggleSurfacePopup);
		document.getElementById('closeTapePopup').addEventListener('click', closeTapePopup);
		document.getElementById('closeSurfacePopup').addEventListener('click', closeSurfacePopup);

		// Close popups on outside click
		document.addEventListener('click', (e) => {
			const path = e.composedPath ? e.composedPath() : (e.path || []);
			if (!path.includes(tapePopup) && !path.includes(document.getElementById('tapeMaterialBtn'))) {
				closeTapePopup();
			}
			if (!path.includes(surfacePopup) && 
			    !path.includes(document.getElementById('surfaceMaterialBtn')) && 
			    !path.includes(document.getElementById('previewSurfaceBtn'))) {
				closeSurfacePopup();
			}
			// Close regular tape dropdown on outside click
			const regularTapeDropdown = document.getElementById('regularTapeDropdown');
			const regularTapeBtn = document.getElementById('regularTapeBtn');
			// Only close dropdown if it's open, and don't deactivate button (tape stays selected)
			if (regularTapeDropdown.classList.contains('show') && 
			    !path.includes(regularTapeDropdown) && !path.includes(regularTapeBtn)) {
				regularTapeDropdown.classList.remove('show');
			}
			// Close surface selection dropdown on outside click
			const surfaceSelectionDropdown = document.getElementById('surfaceSelectionDropdown');
			const previewSurfaceBtn = document.getElementById('previewSurfaceBtn');
			if (!path.includes(surfaceSelectionDropdown) && !path.includes(previewSurfaceBtn)) {
				surfaceSelectionDropdown.classList.remove('show');
				previewSurfaceBtn.classList.remove('active');
			}
		});

		// Close popups on ESC key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				closeTapePopup();
				closeSurfacePopup();
				// Close regular tape dropdown (but don't deactivate - tape stays selected)
				document.getElementById('regularTapeDropdown').classList.remove('show');
				// Close surface selection dropdown
				document.getElementById('surfaceSelectionDropdown').classList.remove('show');
				document.getElementById('previewSurfaceBtn').classList.remove('active');
			}
		});

		// Sync scrollbar thumbs with scroll position
		const tapeFrame = document.querySelector('#tapePopup .popup-frame');
		const surfaceFrame = document.querySelector('#surfacePopup .popup-frame');
		const tapeThumb = document.getElementById('tapeScrollThumb');
		const surfaceThumb = document.getElementById('surfaceScrollThumb');

		function syncScrollbar(frame, thumb) {
			if (!frame || !thumb) return;
			const track = thumb.parentElement;
			const maxTop = track.clientHeight - thumb.clientHeight;
			const scrollRatio = frame.scrollTop / Math.max(1, (frame.scrollHeight - frame.clientHeight));
			thumb.style.top = `${Math.round(scrollRatio * maxTop)}px`;
		}

		if (tapeFrame) tapeFrame.addEventListener('scroll', () => syncScrollbar(tapeFrame, tapeThumb));
		if (surfaceFrame) surfaceFrame.addEventListener('scroll', () => syncScrollbar(surfaceFrame, surfaceThumb));

		// Variant button - opens the variant panel in the sidebar
		document.getElementById('variantBtn').addEventListener('click', () => {
			state.activePanel = 'variant';
			state.showGuidelines = false;
			document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
			renderContent();
			addHistory('Opened Variant panel');
		});

		// Floating tooltip behavior: show a top-level tooltip so it won't be clipped by sidebar overflow
        function setupFloatingTooltips() {
            const tip = document.querySelector('.floating-tip');
            const elementsWithTips = document.querySelectorAll('[data-tip]');
            let showTimeout, hideTimeout;

            elementsWithTips.forEach(elem => {
                elem.addEventListener('mouseenter', (e) => {
                    clearTimeout(hideTimeout);
                    const tipText = elem.getAttribute('data-tip');
                    showTimeout = setTimeout(() => {
                        tip.textContent = tipText;
                        tip.style.display = 'block';
                        tip.classList.add('show');
                        tip.setAttribute('aria-hidden', 'false');
                        
                        const rect = elem.getBoundingClientRect();
                        let left = rect.left + rect.width / 2;
                        let top = rect.top - 10;

                        if (left + 75 > window.innerWidth) left = window.innerWidth - 80;
                        if (left - 75 < 0) left = 80;
                        if (top < 30) top = rect.bottom + 10;

                        tip.style.left = left + 'px';
                        tip.style.top = top + 'px';
                    }, 50);
                });

                elem.addEventListener('mouseleave', () => {
                    clearTimeout(showTimeout);
                    hideTimeout = setTimeout(() => {
                        tip.classList.remove('show');
                        tip.setAttribute('aria-hidden', 'true');
                        setTimeout(() => {
                            tip.style.display = 'none';
                        }, 120);
                    }, 1000);
                });
            });
        }		setupFloatingTooltips();

		// Preview button - toggle preview mode
		document.getElementById('previewBtn').addEventListener('click', () => {
			state.previewMode = !state.previewMode;
			const sidebar = document.querySelector('.sidebar');
			const bottombar = document.querySelector('.bottombar');
			const playground = document.querySelector('.playground');
			const contentPanel = document.querySelector('.content-panel');
			const previewBtn = document.getElementById('previewBtn');

			if (state.previewMode) {
				sidebar.classList.add('hidden');
				bottombar.classList.add('hidden');
				playground.classList.add('preview-mode');
				previewBtn.classList.add('active');
				updatePreviewSurfaceImage();
				addHistory('Entered Preview mode');
			} else {
				sidebar.classList.remove('hidden');
				bottombar.classList.remove('hidden');
				playground.classList.remove('preview-mode');
				previewBtn.classList.remove('active');
				hidePreviewSurfaceImage();
				hidePreviewTapeImages();
				hidePreviewSticker();
				hidePreviewRegularTapeImage();
				// Deactivate variant button when exiting preview
				document.getElementById('variantTapeBtn').classList.remove('active');
				// Hide regular tape dropdown when exiting preview
				document.getElementById('regularTapeBtn').classList.remove('active');
				document.getElementById('regularTapeDropdown').classList.remove('show');
				// Hide surface selection dropdown when exiting preview
				document.getElementById('previewSurfaceBtn').classList.remove('active');
				document.getElementById('surfaceSelectionDropdown').classList.remove('show');
				addHistory('Exited Preview mode');
			}
			togglePreviewHint();
			togglePreviewSlider();
			updatePeelButtonVisibility();
		});
		
		// Show/hide preview hint
		function togglePreviewHint() {
			const hint = document.getElementById('previewHint');
			if (state.previewMode) {
				hint.classList.add('show');
			} else {
				hint.classList.remove('show');
			}
		}
		
		// Show/hide preview slider
		function togglePreviewSlider() {
			const slider = document.getElementById('previewSlider');
			const leftButtons = document.getElementById('previewLeftButtons');
			if (state.previewMode) {
				slider.classList.add('show');
				leftButtons.classList.add('show');
			} else {
				slider.classList.remove('show');
				leftButtons.classList.remove('show');
			}
		}

		// Allow ESC key to exit preview mode
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && state.previewMode) {
				document.getElementById('previewBtn').click();
			}
		});

		// Preview mode button handlers (placeholders for now)
		document.getElementById('variantTapeBtn').addEventListener('click', () => {
			const btn = document.getElementById('variantTapeBtn');
			const isActive = btn.classList.contains('active');
			
			if (state.previewMode) {
				if (isActive) {
					// Deactivate: hide tape images and sticker
					btn.classList.remove('active');
					hidePreviewTapeImages();
					hidePreviewSticker();
					updatePeelButtonVisibility();
				addHistory('Variant Tape preview deactivated');
				} else {
					// Deactivate regular tape if active
					const regularBtn = document.getElementById('regularTapeBtn');
					const regularDropdown = document.getElementById('regularTapeDropdown');
					if (regularBtn.classList.contains('active')) {
						regularBtn.classList.remove('active');
						regularDropdown.classList.remove('show');
					}
					// Always hide regular tape image when showing variant tapes
					hidePreviewRegularTapeImage();
					// Activate: show tape images and animate sticker
					btn.classList.add('active');
					updatePreviewTapeImages();
					showPreviewSticker();
					updatePeelButtonVisibility();
				addHistory('Variant Tape preview activated');
				}
			}
		});

		document.getElementById('regularTapeBtn').addEventListener('click', () => {
			const btn = document.getElementById('regularTapeBtn');
			const dropdown = document.getElementById('regularTapeDropdown');
			const isActive = btn.classList.contains('active');
			
			if (state.previewMode) {
				if (isActive) {
					// Deactivate: hide dropdown, image, and sticker
					btn.classList.remove('active');
					dropdown.classList.remove('show');
					hidePreviewRegularTapeImage();
					hidePreviewSticker();
					updatePeelButtonVisibility();
				addHistory('Regular Tape dropdown closed');
				} else {
					// Deactivate variant tape if active
					const variantBtn = document.getElementById('variantTapeBtn');
					if (variantBtn.classList.contains('active')) {
						variantBtn.classList.remove('active');
						hidePreviewTapeImages();
					}
					// Activate: show dropdown, image, and sticker
					btn.classList.add('active');
					dropdown.classList.add('show');
					updatePreviewRegularTapeImage();
					showPreviewSticker();
					updatePeelButtonVisibility();
				addHistory('Regular Tape dropdown opened');
				}
			}
		});

		// Preview surface button - toggles surface selection dropdown in preview mode
		document.getElementById('previewSurfaceBtn').addEventListener('click', () => {
			const btn = document.getElementById('previewSurfaceBtn');
			const dropdown = document.getElementById('surfaceSelectionDropdown');
			const isActive = btn.classList.contains('active');
			
			if (state.previewMode) {
				if (isActive) {
					// Deactivate: hide dropdown
					btn.classList.remove('active');
					dropdown.classList.remove('show');
					addHistory('Surface selection dropdown closed');
				} else {
					// Activate: show dropdown
					btn.classList.add('active');
					dropdown.classList.add('show');
					updateSurfaceSelectionDropdown(); // Update selection state
					addHistory('Surface selection dropdown opened');
				}
			} else {
				// Outside preview mode, open the surface popup as before
				if (surfacePopup.classList.contains('open')) {
					closeSurfacePopup();
				} else {
					openSurfacePopup();
					closeTapePopup(); // Close tape popup if open
				}
		addHistory('Opened surface selection in preview mode');
	}
});

// Exit preview button - returns to main screen (for phone users)
document.getElementById('exitPreviewBtn').addEventListener('click', () => {
	if (state.previewMode) {
		// Click the preview button to exit preview mode
		document.getElementById('previewBtn').click();
		addHistory('Exited preview mode via exit button');
	}
});	// PEEL button - assess damage when peeling tape from surface
	let peelInProgress = false;
	document.getElementById('peelBtn').addEventListener('click', () => {
		console.log('ðŸ”´ PEEL button clicked');
		
		if (!state.previewMode) {
			console.log('âŒ Not in preview mode');
			return;
		}
		
		// Prevent multiple simultaneous assessments
		if (peelInProgress) {
			console.log('â¸ï¸ PEEL already in progress, ignoring click');
			return;
		}
		
		// Check if tape is selected (variant or regular)
		const variantBtn = document.getElementById('variantTapeBtn');
		const regularBtn = document.getElementById('regularTapeBtn');
		const variantActive = variantBtn.classList.contains('active');
		const regularActive = regularBtn.classList.contains('active');
		
		console.log('ðŸŽ¬ Tape selection state:', { variantActive, regularActive });
		
		if (!variantActive && !regularActive) {
			console.warn('âš ï¸ No tape selected - Please select Variant Tape or Regular Tape first');
			addHistory('PEEL: No tape selected - Select a tape first');
			alert('Please select a tape first!\n\nClick "Variant Tape" or "Regular Tape" button to choose a tape, then try PEEL again.');
			return;
		}
		
		peelInProgress = true;
		assessPeelDamage();
		
		// Reset flag after animation completes (max 4 seconds)
		setTimeout(() => {
			peelInProgress = false;
		}, 4500);
	});

	// Function to assess peel damage and show appropriate sign
	function assessPeelDamage() {
		if (!window.calculateSurfaceDamageRisk) {
			console.error('Damage calculation not loaded');
			return;
		}
		
		const surface = state.params.surface || 'Steel';
		const environment = state.params.environment || 'Dry';
		const timeImpactDays = state.timeImpactDays || 0;
		
		console.log(`PEEL Assessment - Time Impact: ${timeImpactDays} days, Environment: ${environment}, Surface: ${surface}`);
		
		// Determine which tape is active
		const variantBtn = document.getElementById('variantTapeBtn');
		const regularBtn = document.getElementById('regularTapeBtn');
		const variantActive = variantBtn.classList.contains('active');
		const regularActive = regularBtn.classList.contains('active');
		
		let damageResult;
		let tapeDescription;
		
		if (variantActive) {
			// Calculate mixed tape damage
			const tape1 = state.mixedTapes.tape1;
			const tape2 = state.mixedTapes.tape2;
			const adhesive = state.params.adhesive || 'Acrylic';
			
			// Calculate for both tapes and take the worse case
			const damage1 = window.calculateSurfaceDamageRisk({
				surface: surface,
				tape: tape1,
				adhesive: adhesive,
				environment: environment,
				thickness: state.params.thickness || 25,
				timeImpactDays: timeImpactDays,
				width: state.params.width || 100,
				height: state.params.height || 80
			});
			
			const damage2 = window.calculateSurfaceDamageRisk({
				surface: surface,
				tape: tape2,
				adhesive: adhesive,
				environment: environment,
				thickness: state.params.thickness || 25,
				timeImpactDays: timeImpactDays,
				width: state.params.width || 100,
				height: state.params.height || 80
			});
			
			// Use worse case scenario
			damageResult = damage1.safetyFactor < damage2.safetyFactor ? damage1 : damage2;
			tapeDescription = `Variant tape (${tape1} + ${tape2})`;
		} else if (regularActive && state.selectedRegularTape) {
			// Calculate regular tape damage
			const selectedTape = regularTapeOptions.find(t => t.name === state.selectedRegularTape);
			if (!selectedTape) return;
			
			damageResult = window.calculateSurfaceDamageRisk({
				surface: surface,
				tape: selectedTape.backing,
				adhesive: selectedTape.adhesive,
				environment: environment,
				timeImpactDays: timeImpactDays,
				width: selectedTape.width || 48,
				height: state.params.height || 80
			});
			
			tapeDescription = `Regular tape (${state.selectedRegularTape})`;
		}
		
		if (!damageResult) return;
		
		// Determine sign type based on damage risk
		let signImage, signClass, message;
		
		if (!damageResult.canDamage) {
			// Surface cannot be damaged by tape
			signImage = './images/signs/ok_sign.png';
			signClass = 'ok';
			message = `Safe! ${surface} is too strong to be damaged by tape.`;
		} else if (damageResult.safetyFactor > 3) {
			// Safe zone
			signImage = './images/signs/ok_sign.png';
			signClass = 'ok';
			message = `Safe! Safety factor: ${damageResult.safetyFactor.toFixed(2)}x. Surface can withstand the peel force.`;
		} else if (damageResult.safetyFactor > 1.5) {
			// Moderate risk
			signImage = './images/signs/oops_sign.png';
			signClass = 'oops';
			message = `Warning! Safety factor: ${damageResult.safetyFactor.toFixed(2)}x. Possible surface damage - peel carefully!`;
		} else {
			// High risk
			signImage = './images/signs/boom_sign.png';
			signClass = 'boom';
			message = `Danger! Safety factor: ${damageResult.safetyFactor.toFixed(2)}x. High risk of surface damage!`;
		}
		
		// Show the damage sign
		showDamageSign(signImage, signClass, message);
		
		// Add history with time impact information
		const timeInfo = timeImpactDays > 0 ? ` (${timeImpactDays} days aging)` : ' (fresh tape)';
		addHistory(`PEEL assessed: ${tapeDescription} on ${surface}${timeInfo} - ${damageResult.damageRisk}`);
	}

	// Track active animation timeout to allow cleanup
	let damageSignTimeout = null;
	let damageSignCleanupTimeout = null;

	// Function to show damage sign with animation
	function showDamageSign(imageSrc, animationClass, message) {
		const damageSign = document.getElementById('damageSign');
		const surfaceImage = document.getElementById('previewSurfaceImage');
		
		if (!damageSign) {
			console.error('Damage sign element not found!');
			return;
		}
		
		if (!surfaceImage) {
			console.error('Surface image element not found!');
			return;
		}
		
		console.log('ðŸŽ¯ Starting damage sign display:', { 
			imageSrc, 
			animationClass, 
			currentSrc: damageSign.src,
			currentClass: damageSign.className,
			currentDisplay: damageSign.style.display,
			currentOpacity: damageSign.style.opacity
		});
		
		// Clear any existing timeouts
		if (damageSignTimeout) clearTimeout(damageSignTimeout);
		if (damageSignCleanupTimeout) clearTimeout(damageSignCleanupTimeout);
		
		// Clear any existing animation state
		damageSign.className = 'damage-sign';
		damageSign.style.opacity = '0';
		damageSign.style.display = 'block';
		damageSign.style.visibility = 'visible';
		damageSign.style.animation = '';
		damageSign.style.transform = '';
		
		// Position the sign over the surface image
		const surfaceRect = surfaceImage.getBoundingClientRect();
		const playgroundRect = surfaceImage.parentElement.getBoundingClientRect();
		
		// Calculate position relative to playground
		const centerX = surfaceRect.left - playgroundRect.left + surfaceRect.width / 2;
		const centerY = surfaceRect.top - playgroundRect.top + surfaceRect.height / 2;
		
		damageSign.style.left = centerX + 'px';
		damageSign.style.top = centerY + 'px';
		
		console.log('ðŸ“ Positioning sign at:', { 
			centerX, 
			centerY, 
			animationClass,
			surfaceRect: { left: surfaceRect.left, top: surfaceRect.top, width: surfaceRect.width, height: surfaceRect.height }
		});
		
		// Preload image before animating
		const img = new Image();
		img.onload = () => {
			console.log('âœ… Image loaded successfully:', imageSrc);
			damageSign.src = imageSrc;
			
			// Verify the image is set
			console.log('ðŸ–¼ï¸ Damage sign src after setting:', damageSign.src);
			
			// Force reflow to ensure clean animation start
			void damageSign.offsetWidth;
			
			// Add animation class immediately after image is loaded
			requestAnimationFrame(() => {
				damageSign.classList.add(animationClass);
				damageSign.style.opacity = '1';
				console.log('ðŸŽ¬ Animation started:', {
					class: damageSign.className,
					opacity: damageSign.style.opacity,
					display: damageSign.style.display
				});
			});
			
			// Hide after animation completes
			const duration = animationClass === 'boom' ? 4000 : animationClass === 'oops' ? 3500 : 3000;
			damageSignTimeout = setTimeout(() => {
				console.log('â° Animation duration complete, fading out');
				// Animation-fill-mode: forwards keeps the final state, so just fade out
				// Set final transform explicitly to ensure it stays centered
				damageSign.style.transform = 'translate(-50%, -50%) scale(1)';
				damageSign.style.animation = 'none'; // Stop animation
				// Then fade out at the same position
				damageSign.style.opacity = '0';
				damageSignCleanupTimeout = setTimeout(() => {
					damageSign.className = 'damage-sign';
					damageSign.style.display = 'none';
					damageSign.style.visibility = 'hidden';
					damageSign.style.transform = '';
					damageSign.style.animation = '';
					console.log('âœ¨ Cleanup complete');
				}, 300);
			}, duration);
		};
		
		img.onerror = () => {
			console.error('âŒ Failed to load sign image:', imageSrc);
		};
		
		img.src = imageSrc;
		console.log('ðŸ’¬', message);
	}

	// Function to update PEEL button visibility
	function updatePeelButtonVisibility() {
		const peelBtn = document.getElementById('peelBtn');
		const peelHint = document.getElementById('peelHint');
		if (!peelBtn) return;
		
		const variantBtn = document.getElementById('variantTapeBtn');
		const regularBtn = document.getElementById('regularTapeBtn');
		const variantActive = variantBtn && variantBtn.classList.contains('active');
		const regularActive = regularBtn && regularBtn.classList.contains('active');
		
		// Show PEEL button only in preview mode when tape is selected
		if (state.previewMode && (variantActive || regularActive)) {
			peelBtn.classList.add('show');
			peelBtn.classList.remove('disabled');
			if (peelHint) peelHint.classList.add('show');
		} else if (state.previewMode) {
			peelBtn.classList.add('show');
			peelBtn.classList.add('disabled');
			if (peelHint) peelHint.classList.remove('show');
		} else {
			peelBtn.classList.remove('show');
			if (peelHint) peelHint.classList.remove('show');
		}
	}

		// Function to update playground background based on environment
		function updatePlaygroundBackground(environment) {
			const background = document.getElementById('playgroundBackground');
			if (!background) return;
			
			const imageMap = {
				'Humid': './images/Humid.jpg',
				'Tropical': './images/Tropical.jpg',
				'Semiarid': './images/Semiarid.jpg',
				'Arid': './images/Arid.jpg',
				'Dry': './images/Dry.jpg'
			};
			
			const imagePath = imageMap[environment];
			if (imagePath) {
				background.style.backgroundImage = `url('${imagePath}')`;
				background.classList.add('visible');
			} else {
				background.classList.remove('visible');
			}
		}

		// Function to update preview surface image based on selected surface
		function updatePreviewSurfaceImage() {
			const previewImage = document.getElementById('previewSurfaceImage');
			if (!previewImage) return;

			// Find the selected surface material
			const selectedSurface = surfaceMaterials.find(mat => mat.name === state.params.surface);
			if (selectedSurface && selectedSurface.image) {
				previewImage.src = selectedSurface.image;
				previewImage.classList.add('visible');
			} else {
				previewImage.classList.remove('visible');
			}
		}

		// Function to hide preview surface image
		function hidePreviewSurfaceImage() {
			const previewImage = document.getElementById('previewSurfaceImage');
			if (previewImage) {
				previewImage.classList.remove('visible');
			}
		}

		// Function to update preview tape images based on selected variant tapes
		function updatePreviewTapeImages() {
			const tapeImage1 = document.getElementById('previewTapeImage1');
			const tapeImage2 = document.getElementById('previewTapeImage2');
			
			if (!tapeImage1 || !tapeImage2) return;

			// Find the selected tape materials
			const selectedTape1 = tapeMaterials.find(mat => mat.name === state.mixedTapes.tape1);
			const selectedTape2 = tapeMaterials.find(mat => mat.name === state.mixedTapes.tape2);

			if (selectedTape1 && selectedTape1.image) {
				tapeImage1.src = selectedTape1.image;
				tapeImage1.classList.add('visible');
			} else {
				tapeImage1.classList.remove('visible');
			}

			if (selectedTape2 && selectedTape2.image) {
				tapeImage2.src = selectedTape2.image;
				tapeImage2.classList.add('visible');
			} else {
				tapeImage2.classList.remove('visible');
			}
			
			// Apply yellow tint based on time impact
			updateTapeYellowTint();
		}

		// Function to hide preview tape images
		function hidePreviewTapeImages() {
			const tapeImage1 = document.getElementById('previewTapeImage1');
			const tapeImage2 = document.getElementById('previewTapeImage2');
			
			if (tapeImage1) {
				tapeImage1.classList.remove('visible');
				tapeImage1.style.filter = '';
			}
			if (tapeImage2) {
				tapeImage2.classList.remove('visible');
				tapeImage2.style.filter = '';
			}
		}

		// Function to show preview sticker with slide-in animation
		function showPreviewSticker() {
			const sticker = document.getElementById('previewStickerVariant');
			if (sticker) {
				// Small delay to ensure smooth animation
				setTimeout(() => {
					sticker.classList.add('visible');
				}, 100);
			}
		}

		// Function to hide preview sticker
		function hidePreviewSticker() {
			const sticker = document.getElementById('previewStickerVariant');
			if (sticker) {
				sticker.classList.remove('visible');
			}
		}

		// Function to update preview regular tape image
		function updatePreviewRegularTapeImage() {
			const regularTapeImage = document.getElementById('previewRegularTapeImage');
			if (!regularTapeImage) return;

			if (!state.selectedRegularTape) {
				regularTapeImage.classList.remove('visible');
				return;
			}

			// Find the selected regular tape
			const selectedTape = regularTapeOptions.find(tape => tape.name === state.selectedRegularTape);
			if (selectedTape) {
				// Find the corresponding tape material image based on backing type
				const tapeMaterial = tapeMaterials.find(mat => mat.name === selectedTape.backing);
			if (tapeMaterial && tapeMaterial.image) {
				regularTapeImage.src = tapeMaterial.image;
				regularTapeImage.classList.add('visible');
				// Apply yellow tint based on time impact
				updateTapeYellowTint();
			} else {
				regularTapeImage.classList.remove('visible');
			}
		} else {
			regularTapeImage.classList.remove('visible');
		}
	}		// Function to hide preview regular tape image
		function hidePreviewRegularTapeImage() {
			const regularTapeImage = document.getElementById('previewRegularTapeImage');
			if (regularTapeImage) {
				regularTapeImage.classList.remove('visible');
				regularTapeImage.style.filter = '';
			}
		}

		// Function to update yellow tint on all visible tape images based on time impact
		function updateTapeYellowTint() {
			if (!window.calculateTapeYellowTint) return; // Wait for module to load
			
			const timeImpactDays = state.timeImpactDays || 0;
			const environment = state.params.environment || 'Dry';
			const surface = state.params.surface || 'Steel';
			
			// Update variant tape images (tape1 and tape2)
			const variantBtn = document.getElementById('variantTapeBtn');
			if (variantBtn && variantBtn.classList.contains('active')) {
				// Calculate tint for tape1
				if (state.mixedTapes.tape1) {
					const tape1Image = document.getElementById('previewTapeImage1');
					if (tape1Image && tape1Image.classList.contains('visible')) {
						const tint1 = window.calculateTapeYellowTint({
							backing: state.mixedTapes.tape1,
							adhesive: state.params.adhesive || 'Acrylic',
							environment: environment,
							surface: surface,
							timeImpactDays: timeImpactDays
						});
						tape1Image.style.filter = tint1.cssFilter;
					}
				}
				
				// Calculate tint for tape2
				if (state.mixedTapes.tape2) {
					const tape2Image = document.getElementById('previewTapeImage2');
					if (tape2Image && tape2Image.classList.contains('visible')) {
						const tint2 = window.calculateTapeYellowTint({
							backing: state.mixedTapes.tape2,
							adhesive: state.params.adhesive || 'Acrylic',
							environment: environment,
							surface: surface,
							timeImpactDays: timeImpactDays
						});
						tape2Image.style.filter = tint2.cssFilter;
					}
				}
			}
			
			// Update regular tape image
			const regularBtn = document.getElementById('regularTapeBtn');
			if (regularBtn && regularBtn.classList.contains('active') && state.selectedRegularTape) {
				const regularTapeImage = document.getElementById('previewRegularTapeImage');
				if (regularTapeImage && regularTapeImage.classList.contains('visible')) {
					// Find the selected regular tape configuration
					const selectedTape = regularTapeOptions.find(tape => tape.name === state.selectedRegularTape);
					if (selectedTape) {
						const tint = window.calculateTapeYellowTint({
							backing: selectedTape.backing,
							adhesive: selectedTape.adhesive,
							environment: environment,
							surface: surface,
							timeImpactDays: timeImpactDays
						});
						regularTapeImage.style.filter = tint.cssFilter;
					}
				}
			}
		}

		// Initialize
		function initializeApp() {
			loadState();
			renderContent();
			updatePlaygroundBackground(state.params.environment || 'Dry');
			document.querySelectorAll('.sidebar-btn[data-panel]').forEach(btn => {
				if (btn.getAttribute('data-panel') === state.activePanel) {
					btn.classList.add('active');
				}
			});
		}
		
		// Wait for math module to load before initializing
		if (window.mathModuleLoaded) {
			initializeApp();
		} else {
			window.addEventListener('mathModuleReady', initializeApp);
		}

		// Time Impact Slider functionality
		function initTimeSlider() {
			const slider = document.getElementById('timeSlider');
			const valueDisplay = document.getElementById('sliderValue');
			
			if (!slider || !valueDisplay) {
				console.error('Slider elements not found:', { slider, valueDisplay });
				return;
			}

			console.log('Initializing slider...', slider, valueDisplay);

		// Update display and state when slider changes
		slider.addEventListener('input', (e) => {
			const value = sanitizeNumber(e.target.value, 0, 366, 0);
			console.log('Slider input:', value);
			valueDisplay.textContent = value;
			state.timeImpactDays = value;				// Debug: Check tape button state BEFORE slider operations
				const variantBtn = document.getElementById('variantTapeBtn');
				const regularBtn = document.getElementById('regularTapeBtn');
				console.log('ðŸ” Tape button state BEFORE slider operations:', {
					variantActive: variantBtn?.classList.contains('active'),
					regularActive: regularBtn?.classList.contains('active')
				});
				
				// Debug: Check damage sign state before updates
				const damageSign = document.getElementById('damageSign');
				console.log('ðŸ” Damage sign state before slider operations:', {
					exists: !!damageSign,
					display: damageSign?.style.display,
					opacity: damageSign?.style.opacity,
					visibility: damageSign?.style.visibility,
					className: damageSign?.className
				});
				
				// Update yellow tint on tape images in preview mode
				if (state.previewMode) {
					updateTapeYellowTint();
				}
				
				// Recalculate specifics if that panel is open
				if (state.activePanel === 'specifics') {
					renderContent();
				}
				
				// Debug: Check states AFTER slider operations
				console.log('ðŸ” Tape button state AFTER slider operations:', {
					variantActive: variantBtn?.classList.contains('active'),
					regularActive: regularBtn?.classList.contains('active')
				});
				console.log('ðŸ” Damage sign state after slider operations:', {
					exists: !!damageSign,
					display: damageSign?.style.display,
					opacity: damageSign?.style.opacity,
					visibility: damageSign?.style.visibility,
					className: damageSign?.className
				});
			});

			// Add history entry when user releases slider
			slider.addEventListener('change', (e) => {
				const value = parseInt(e.target.value);
				console.log('Slider change:', value);
				addHistory(`Time impact set to ${value} days`);
			});
			
			// Set initial value
			valueDisplay.textContent = '0';
		}

		// Call initTimeSlider after DOM is fully loaded
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initTimeSlider);
		} else {
			initTimeSlider();
		}
	</script>
</body>
</html>
