<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Tape Testing UI - Responsive demo with sidebar, playground, and controls" />
	<title>TapeTesting</title>
	<!-- Link CSS files for responsive layouts -->
	<link rel="stylesheet" href="./display and css/desktop.css" />
	<link rel="stylesheet" href="./display and css/tablet.css" />
	<link rel="stylesheet" href="./display and css/phone.css" />
	<style>
		:root {
			--gap: 16px;
			--item-bg: #f3f4f6;
			--accent: #0ea5a4;
			--sidebar-width: 20vw;
			--bottom-height: calc(20vh - 15px);
			--sidebar-height: auto;
			--primary-color: #2563eb;
			--secondary-color: #fef3c7;
		}

		html, body {
			height: 100%;
			margin: 0;
			font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			background: #fff;
		}

		body {
			display: flex;
			flex-direction: column;
		}

		/* Main app layout */
		.app-container {
			display: flex;
			flex: 1;
			position: relative;
			min-height: 100vh;
		}

		/* Sidebar */
		.sidebar {
			position: fixed;
			left: 0;
			top: 0;
			bottom: 0;
			width: var(--sidebar-width);
			background: #fff;
			border-right: 4px solid var(--primary-color);
			padding: 16px;
			box-sizing: border-box;
			z-index: 2;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 16px;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.sidebar.hidden {
			transform: translateX(-100%);
			opacity: 0;
			pointer-events: none;
		}

		.sidebar-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			border-radius: 4px;
			padding: 12px 16px;
			background: #fff;
			cursor: pointer;
			font-size: 0.95rem;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
			text-align: left;
		}

		/* Tooltip for sidebar buttons (small helper text on hover) */
		/* Hide the earlier pseudo-element tooltips; we'll use a floating tooltip appended to <body> */
		.sidebar-btn[data-tip]::after,
		.sidebar-btn[data-tip]::before,
		.save-btn[data-tip]::after,
		.save-btn[data-tip]::before {
			display: none !important;
		}

		/* Floating tooltip that sits on top of everything */
		.floating-tip {
			position: fixed;
			display: none;
			background: rgba(17, 24, 39, 0.95);
			color: #fff;
			padding: 6px 10px;
			border-radius: 6px;
			font-size: 0.78rem;
			white-space: nowrap;
			z-index: 99999;
			pointer-events: none; /* disabled until visible so it won't block interactions */
			box-shadow: 0 8px 24px rgba(0,0,0,0.2);
			transition: opacity 0.12s ease;
			opacity: 0;
		}

		.floating-tip.show {
			display: block;
			opacity: 1;
			pointer-events: auto; /* allow mouse to enter the tip itself so it can cancel hide */
		}

		.sidebar-btn:hover {
			background: #eff6ff;
		}

		.sidebar-btn.active {
			background: #eff6ff;
			border-color: #1e40af;
		}

		.sidebar-btn svg {
			width: 18px;
			height: 18px;
			stroke: currentColor;
		}

		.sidebar-divider {
			border-top: 1px solid #93c5fd;
			margin: 8px 0;
		}

		/* Save button - full width, blue fill */
		.save-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			background: var(--primary-color);
			color: #fff;
			border-radius: 4px;
			padding: 12px 16px;
			cursor: pointer;
			font-size: 0.95rem;
			font-weight: 600;
			transition: all 0.2s ease;
		}

		.save-btn:hover {
			background: #1e40af;
			border-color: #1e40af;
		}

		.save-btn.active {
			background: #fff;
			color: var(--primary-color);
			border-color: var(--primary-color);
		}

		/* Playground / Main content area */
		.playground {
			margin-left: var(--sidebar-width);
			margin-bottom: var(--bottom-height);
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto;
			background: #fff;
			flex: 1;
			transition: margin-left 0.3s ease, margin-bottom 0.3s ease;
			position: relative;
			height: calc(100vh - var(--bottom-height));
		}

		.playground.preview-mode {
			margin-left: 0;
			margin-bottom: 0;
			height: 100vh;
		}

		/* Background environment image */
		.playground-background {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 0;
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
			opacity: 0;
			transition: opacity 0.5s ease;
			pointer-events: none;
		}

		.playground-background.visible {
			opacity: 0.4;
		}

		/* Sticker note - always visible, centered */
		.playground-sticker {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 700px;
			max-width: 80%;
			height: auto;
			z-index: 0.5;
			opacity: 0.9;
			pointer-events: none;
		}

		.content-panel {
			border: 4px solid var(--primary-color);
			border-radius: 4px;
			background: #f9fafb;
			padding: 24px;
			overflow-y: auto;
			max-height: calc(100vh - var(--bottom-height) - 48px);
			height: fit-content;
			box-sizing: border-box;
			padding-bottom: 40px;
			transition: opacity 0.3s ease, transform 0.3s ease;
			position: relative;
			z-index: 1;
		}

		.playground.preview-mode .content-panel {
			opacity: 0;
			transform: scale(0.95);
			pointer-events: none;
		}

		.content-panel h2 {
			font-size: 1.5rem;
			font-weight: 600;
			margin: 0 0 16px 0;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 16px;
			max-width: 400px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.form-group label {
			font-size: 0.9rem;
			font-weight: 500;
		}

		.form-group input,
		.form-group select {
			padding: 8px 12px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			font-size: 0.95rem;
			box-sizing: border-box;
		}

		.form-group input:focus,
		.form-group select:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}

		.preview-box {
			margin: 24px 0;
			padding: 16px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			background: #fff;
			min-height: 200px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.preview-content {
			text-align: center;
			border: 2px dashed #d1d5db;
			padding: 40px;
			border-radius: 4px;
			width: 100%;
		}

		.preview-content .title {
			font-size: 1.1rem;
			font-weight: 500;
		}

		.preview-content .subtitle {
			font-size: 0.9rem;
			color: #6b7280;
			margin-top: 8px;
		}

		.history-list {
			list-style: none;
			padding: 0;
			margin: 0;
			max-height: 280px;
			overflow-y: auto;
		}

		.history-list li {
			padding: 8px;
			font-size: 0.85rem;
			border-bottom: 1px solid #e5e7eb;
		}

		.history-list li:last-child {
			border-bottom: none;
		}

		.guidelines-box {
			margin-top: 24px;
			padding: 16px;
			border: 1px solid #fbbf24;
			background: #fef3c7;
			border-radius: 4px;
		}

		.guidelines-box h3 {
			margin: 0 0 12px 0;
			font-weight: 600;
		}

		.guidelines-box ol {
			margin: 0;
			padding-left: 20px;
			font-size: 0.9rem;
		}

		/* Time slider in preview mode - Vertical on right side */
		.preview-slider-container {
			position: fixed;
			right: 30px;
			top: 50%;
			transform: translateY(-50%);
			height: 400px;
			max-height: 70vh;
			background: rgba(0, 0, 0, 0.85);
			padding: 24px 20px;
			border-radius: 12px;
			z-index: 41;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
			backdrop-filter: blur(8px);
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 16px;
		}

		.preview-slider-container.show {
			opacity: 1;
			pointer-events: auto;
		}

		.slider-label {
			font-size: 0.75rem;
			color: rgba(255, 255, 255, 0.9);
			text-align: center;
			font-weight: 500;
			writing-mode: vertical-rl;
			text-orientation: mixed;
			transform: rotate(180deg);
			margin: 0;
		}

		.time-slider {
			width: 6px;
			height: 100%;
			-webkit-appearance: slider-vertical;
			appearance: slider-vertical;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 3px;
			outline: none;
			cursor: pointer;
			writing-mode: bt-lr;
			flex: 1;
		}

		.time-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			appearance: none;
			width: 18px;
			height: 18px;
			background: #3b82f6;
			border: 2px solid #fff;
			border-radius: 50%;
			cursor: grab;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}

		.time-slider::-webkit-slider-thumb:hover {
			background: #2563eb;
			box-shadow: 0 3px 12px rgba(0,0,0,0.4);
		}

		.time-slider::-webkit-slider-thumb:active {
			cursor: grabbing;
			box-shadow: 0 4px 16px rgba(0,0,0,0.5);
		}

		.time-slider::-moz-range-thumb {
			width: 18px;
			height: 18px;
			background: #3b82f6;
			border: 2px solid #fff;
			border-radius: 50%;
			cursor: grab;
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}

		.time-slider::-moz-range-thumb:hover {
			background: #2563eb;
			box-shadow: 0 3px 12px rgba(0,0,0,0.4);
		}

		.time-slider::-moz-range-thumb:active {
			cursor: grabbing;
			box-shadow: 0 4px 16px rgba(0,0,0,0.5);
		}

		.slider-value-display {
			text-align: center;
			font-size: 0.9rem;
			color: rgba(255, 255, 255, 0.9);
			font-weight: 600;
		}

		.slider-current-value {
			color: #60a5fa;
			font-size: 1.15rem;
			font-weight: 700;
			text-shadow: 0 1px 3px rgba(0,0,0,0.3);
			display: block;
		}

		/* Bottom bar */
		.bottombar {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			height: var(--bottom-height);
			background: #fff;
			border-top: 4px solid var(--primary-color);
			padding: 0;
			box-sizing: border-box;
			z-index: 3;
			display: flex;
			align-items: center;
			justify-content: space-between;
			overflow: hidden;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.bottombar.hidden {
			transform: translateY(100%);
			opacity: 0;
			pointer-events: none;
		}

		.bottom-content {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 100%;
			padding: 40px 20px;
			box-sizing: border-box;
			gap: 20px;
		}

		.material-selector {
			position: relative;
			display: flex;
			flex: 1;
			min-width: 0;
		}

		.material-btn {
			border: 2px solid var(--primary-color);
			background: #fff;
			border-radius: 4px;
			padding: 8px 17px;
			cursor: pointer;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			transition: all 0.2s ease;
			flex: 1;
			min-width: 0;
		}

		.material-btn:hover {
			background: #eff6ff;
		}

		.material-badge {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: #fbcfe8;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.material-dropdown {
			position: fixed;
			width: 160px;
			background: #fff;
			border: 2px solid #93c5fd;
			border-radius: 4px;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
			padding: 12px;
			z-index: 100000;
			display: none;
			pointer-events: auto;
		}

		.material-dropdown.open {
			display: block;
		}

		/* Material popup windows - appear above bottom buttons */
		.material-popup {
			position: fixed;
			bottom: calc(var(--bottom-height) + 20px);
			width: 44%;
			max-width: 500px;
			height: 280px;
			border: 6px solid var(--primary-color);
			border-radius: 8px;
			background: white;
			box-shadow: 0 8px 28px rgba(0, 0, 0, 0.15);
			z-index: 100001;
			display: none;
			opacity: 0;
			transform: translateY(10px) scale(0.98);
			transition: transform 0.18s cubic-bezier(0.2, 0.9, 0.2, 1), opacity 0.12s;
			box-sizing: border-box;
			overflow: hidden;
		}

		.material-popup.left { left: 6%; }
		.material-popup.right { right: 6%; }

		.material-popup.open {
			display: flex;
			opacity: 1;
			transform: translateY(-10px) scale(1);
		}

		.popup-inner-content {
			flex: 1;
			display: flex;
			padding: 18px;
			box-sizing: border-box;
			position: relative;
		}

		.popup-frame {
			flex: 1;
			border: 4px solid rgba(37, 99, 235, 0.15);
			border-radius: 6px;
			padding: 16px;
			box-sizing: border-box;
			background: #fbfbfb;
			overflow-y: auto;
			overflow-x: hidden;
			position: relative;
		}

		.popup-close {
			position: absolute;
			top: 12px;
			right: 12px;
			border: none;
			background: transparent;
			font-size: 24px;
			line-height: 1;
			cursor: pointer;
			color: #6b7280;
			padding: 4px 8px;
			transition: color 0.2s ease;
			z-index: 10;
		}

		.popup-close:hover { color: #1f2937; }

		.popup-title {
			margin: 0 0 16px 0;
			font-size: 1.2rem;
			font-weight: 600;
			color: #1f2937;
		}

		.mixing-header {
			font-size: 0.75rem;
			color: #6b7280;
			margin: 0 0 12px 0;
			padding-bottom: 8px;
			border-bottom: 1px solid rgba(37, 99, 235, 0.2);
			text-align: center;
		}

		.tape-columns-container {
			display: flex;
			gap: 12px;
			width: 100%;
		}

		.tape-column {
			flex: 1;
			min-width: 0;
		}

		/* Vertical scrollbar handle */
		.popup-scrollbar {
			width: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 4px;
		}

		.scrollbar-track {
			width: 6px;
			background: #e5e7eb;
			border-radius: 8px;
			height: 180px;
			position: relative;
		}

		.scrollbar-thumb {
			width: 6px;
			height: 60px;
			background: var(--primary-color);
			border-radius: 4px;
			position: absolute;
			top: 0;
			transition: top 0.1s ease;
		}

		/* Tape material pills (left popup) */
		.material-pills {
			display: flex;
			flex-direction: column;
			gap: 8px;
			padding: 4px;
		}

		.material-pill {
			background: #eff6ff;
			padding: 14px 20px;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 500;
			color: #1f2937;
			box-shadow: inset 0 -2px 0 rgba(0, 0, 0, 0.03);
			cursor: pointer;
			transition: all 0.2s ease;
			border: 2px solid transparent;
		}

		.material-pill:hover {
			background: #dbeafe;
			transform: translateX(4px);
		}

		.material-pill.selected {
			background: #bfdbfe;
			border-color: var(--primary-color);
			font-weight: 600;
		}

		/* Surface material grid (right popup) */
		.material-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
			align-items: start;
			justify-items: center;
		}

		.material-tile-wrap {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 8px;
			cursor: pointer;
		}

		.material-tile {
			width: 110px;
			height: 75px;
			border: 4px solid rgba(37, 99, 235, 0.2);
			border-radius: 6px;
			display: flex;
			align-items: center;
			justify-content: center;
			position: relative;
			box-sizing: border-box;
			background: white;
			transition: all 0.2s ease;
			overflow: hidden;
		}

		.material-tile-wrap:hover .material-tile {
			border-color: var(--primary-color);
			transform: translateY(-3px);
			box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
		}

		.material-tile.selected {
			border-color: var(--primary-color);
			border-width: 5px;
			box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
		}

		.material-tile svg {
			width: 100%;
			height: 100%;
		}

		.material-tile img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			object-position: center;
		}

		.material-tile img[src*="glass.png"] {
			transform: rotate(90deg);
			width: 140%;
			height: 140%;
		}

		.material-tile-label {
			font-size: 0.85rem;
			text-align: center;
			color: #4b5563;
			font-weight: 500;
		}

		.bottom-right {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 12px;
			margin-left: auto;
			flex-shrink: 0;
		}

		.bottom-right .status {
			font-size: 0.85rem;
			color: #4b5563;
		}

		.apply-btn {
			padding: 8px 16px;
			border: 1px solid var(--primary-color);
			background: #fff;
			color: var(--primary-color);
			border-radius: 4px;
			cursor: pointer;
			font-weight: 500;
			transition: all 0.2s ease;
		}

		.apply-btn:hover {
			background: #eff6ff;
		}

		.save-notice {
			position: fixed;
			bottom: 30px;
			right: 20px;
			background: #dcfce7;
			border: 1px solid #86efac;
			padding: 12px 16px;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			z-index: 50;
			display: none;
		}

		.save-notice.show {
			display: block;
		}

		/* Preview mode hint */
		.preview-hint {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			padding: 12px 20px;
			border-radius: 24px;
			font-size: 0.85rem;
			text-align: center;
			z-index: 40;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.preview-hint.show {
			opacity: 1;
			pointer-events: auto;
		}

		/* QR Code */
		.qr-code {
			display: none;
			margin: 20px auto 0;
			text-align: center;
			position: relative;
			z-index: 1;
		}

		.qr-code.show {
			display: block;
		}

		.qr-code img {
			width: 200px;
			height: auto;
			display: inline-block;
		}

		/* Phone/responsive */
		@media (max-width: 480px) {
			:root {
				--sidebar-width: 100vw;
				--bottom-height: 20vh;
				--sidebar-height: 20vh;
			}

			.sidebar {
				position: fixed;
				left: 0;
				right: 0;
				top: 0;
				height: var(--sidebar-height);
				width: 100%;
				bottom: auto;
				border-right: none;
				border-bottom: 4px solid var(--primary-color);
				z-index: 3;
				flex-direction: row;
				overflow-x: auto;
				padding: 8px;
			}

			.sidebar-btn {
				flex-shrink: 0;
				min-width: 100px;
				padding: 8px 12px;
				font-size: 0.85rem;
			}

			.sidebar-divider {
				display: none;
			}

			.playground {
				margin-left: 0;
				margin-top: var(--sidebar-height);
				margin-bottom: var(--bottom-height);
				min-height: calc(100vh - var(--sidebar-height) - var(--bottom-height));
			}

			.bottombar {
				left: 0;
				right: 0;
				bottom: 0;
			}

			.bottom-content {
				flex-wrap: wrap;
				justify-content: center;
				padding: 8px 12px;
			}

			.bottom-right {
				width: 100%;
				justify-content: center;
				margin-left: 0;
				margin-top: 8px;
			}

			.preview-slider-container {
				right: 10px;
				height: 50vh;
				max-height: 50vh;
				padding: 16px 12px;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar -->
		<aside class="sidebar" aria-label="Sidebar">
			<button class="sidebar-btn active" data-panel="dimensions" data-tip="Set width & height">
				<span>Dimensions</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="specifics" data-tip="Thickness, adhesive, tolerances">
				<span>Specifics</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="environment" data-tip="Temperature & humidity">
				<span>Environment</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>

			<button class="save-btn" data-panel="save" data-tip="Save current parameters">
				Save Parameters
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" id="previewBtn" title="Preview mode - hides sidebar and bottom bar" data-tip="Toggle full-screen preview">
				Preview
			</button>

			<button class="sidebar-btn" data-panel="history" data-tip="View recent changes">
				History Log
			</button>

			<button class="sidebar-btn" data-panel="guidelines" data-tip="Show design guidelines">
				Guidelines
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" id="resetBtn" data-tip="Reset all parameters">
				RESET
			</button>
		</aside>

		<!-- Main Playground -->
		<section class="playground" aria-label="Playground">
			<div class="playground-background" id="playgroundBackground"></div>
			<img src="./images/Sticker_note.jpg" alt="Sticker note" class="playground-sticker" />
			<div class="content-panel" id="contentPanel">
				<!-- Content inserted here by JS -->
			</div>
		</section>

		<!-- Bottom Bar -->
		<div class="bottombar" aria-label="Bottom bar">
			<div class="bottom-content">
				<div class="material-selector">
					<button class="material-btn" id="variantBtn">
						<span class="material-badge">V</span>
						<span>Variant</span>
					</button>
				</div>

				<div class="material-selector">
					<button class="material-btn" id="tapeMaterialBtn">
						<span class="material-badge">T</span>
						<span>Tape Material</span>
					</button>
				</div>

				<div class="material-selector">
					<button class="material-btn" id="surfaceMaterialBtn">
						<span class="material-badge">S</span>
						<span>Surface Material</span>
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Material popup windows -->
	<!-- Tape Material Popup (Left) -->
	<div class="material-popup left" id="tapePopup">
		<div class="popup-inner-content">
			<div class="popup-frame">
				<button class="popup-close" id="closeTapePopup" title="Close">&times;</button>
				<h3 class="popup-title">Tape Materials</h3>
				<div class="mixing-header">Choose types for mixing</div>
				<div class="tape-columns-container">
					<div class="tape-column">
						<div class="material-pills" id="tapePills1">
							<!-- Pills added by JS -->
						</div>
					</div>
					<div class="tape-column">
						<div class="material-pills" id="tapePills2">
							<!-- Pills added by JS -->
						</div>
					</div>
				</div>
			</div>
			<div class="popup-scrollbar">
				<div class="scrollbar-track">
					<div class="scrollbar-thumb" id="tapeScrollThumb"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Surface Material Popup (Right) -->
	<div class="material-popup right" id="surfacePopup">
		<div class="popup-inner-content">
			<div class="popup-frame">
				<button class="popup-close" id="closeSurfacePopup" title="Close">&times;</button>
				<h3 class="popup-title">Surface Materials</h3>
				<div class="material-grid" id="surfaceGrid">
					<!-- Tiles added by JS -->
				</div>
			</div>
			<div class="popup-scrollbar">
				<div class="scrollbar-track">
					<div class="scrollbar-thumb" id="surfaceScrollThumb"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Save notice -->
	<div class="save-notice" id="saveNotice">Saved</div>

	<!-- Scripts -->
	<!-- Preview mode hint -->
	<div class="preview-hint" id="previewHint">Press ESC to exit preview mode</div>

	<!-- Time slider in preview mode -->
	<div class="preview-slider-container" id="previewSlider">
		<div class="slider-value-display">
			<span class="slider-current-value"><span id="sliderValue">0</span> days</span>
		</div>
		<input type="range" min="0" max="366" value="0" class="time-slider" id="timeSlider" orient="vertical" />
		<div class="slider-label">Time Impact</div>
	</div>

	<!-- Floating tooltip shown above all content -->
	<div id="floatingTip" class="floating-tip" aria-hidden="true"></div>

	<script type="module" src="./display and css/desktop_size.js"></script>
	<script type="module" src="./display and css/tablet_size.js"></script>
	<script type="module" src="./display and css/phone_size.js"></script>

	<script type="module">
		// Import calculation functions
		import { calculateTapeProperties, getMaterialInfo, calculateMixedTapeProperties, BACKING_MATERIALS, ADHESIVE_TYPES, SURFACE_MATERIALS, ENVIRONMENTAL_CONDITIONS } from './display and css/math_reasoning.js';
		
		// Make functions available globally
		window.calculateTapeProperties = calculateTapeProperties;
		window.getMaterialInfo = getMaterialInfo;
		window.calculateMixedTapeProperties = calculateMixedTapeProperties;
		window.BACKING_MATERIALS = BACKING_MATERIALS;
		window.ADHESIVE_TYPES = ADHESIVE_TYPES;
		window.SURFACE_MATERIALS = SURFACE_MATERIALS;
		window.ENVIRONMENTAL_CONDITIONS = ENVIRONMENTAL_CONDITIONS;
		
		// Signal that the module is loaded
		window.mathModuleLoaded = true;
		window.dispatchEvent(new Event('mathModuleReady'));
	</script>

	<script>
		// UI State
		const state = {
			activePanel: 'dimensions',
			params: { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic', environment: 'Dry' },
			history: [],
			experiments: [],
			showGuidelines: false,
			materialPanel: { tape: false, surface: false },
			previewMode: false,
			timeImpactDays: 0,
			mixedTapes: { tape1: null, tape2: null }
		};

		const tapeOptions = ['PVC', 'Polypropylene', 'Cloth', 'Foam'];
		const surfaceOptions = ['Steel', 'Aluminum', 'Glass', 'Plastic'];

		// Load from localStorage
		function loadState() {
			const saved = localStorage.getItem('tape_ui_params');
			if (saved) state.params = JSON.parse(saved);
			const savedHistory = localStorage.getItem('tape_ui_history');
			if (savedHistory) state.history = JSON.parse(savedHistory);
			const savedExperiments = localStorage.getItem('tape_ui_experiments');
			if (savedExperiments) state.experiments = JSON.parse(savedExperiments);
		}

		// Save to localStorage
		function saveState() {
			localStorage.setItem('tape_ui_params', JSON.stringify(state.params));
			localStorage.setItem('tape_ui_history', JSON.stringify(state.history));
			localStorage.setItem('tape_ui_experiments', JSON.stringify(state.experiments));
		}

		// Add history entry
		function addHistory(entry) {
			const time = new Date().toLocaleString();
			state.history.unshift({ time, text: entry });
			state.history = state.history.slice(0, 50);
			saveState();
		}

		// Render content based on active panel
		function renderContent() {
			const panel = document.getElementById('contentPanel');
			// Clear panel first so closing a panel removes its content immediately
			panel.innerHTML = '';
			const { width, height } = state.params;

			switch (state.activePanel) {
			case 'dimensions':
				// Get backing material info
				const backingInfo = window.getMaterialInfo('backing', state.params.tape) || {};
				const totalThickness = window.calculateTapeProperties ? 
					window.calculateTapeProperties(state.params).totalThickness : 
					(backingInfo.typicalThickness?.standard || 120);
				
				panel.innerHTML = `
					<h2>Dimensions</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Sample dimensions and backing material specifications</p>
					<div class="form-grid">
						<div class="form-group">
							<label>Width (mm)</label>
							<input type="number" id="widthInput" value="${width}" />
						</div>
						<div class="form-group">
							<label>Height (mm)</label>
							<input type="number" id="heightInput" value="${height}" />
						</div>
					</div>
					
					${backingInfo.name ? `
					<div style="margin-top: 24px; padding: 16px; background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px;">
						<h3 style="margin: 0 0 12px 0; font-size: 0.95rem; color: #1e40af; font-weight: 600;">Selected Backing: ${backingInfo.name}</h3>
						<div style="font-size: 0.85rem; line-height: 1.7; color: #374151;">
							<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dbeafe;">
								<span>Typical Thickness:</span>
								<strong>${backingInfo.typicalThickness?.standard || 120} ¬µm</strong>
							</div>
							<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dbeafe;">
								<span>Range:</span>
								<strong>${backingInfo.typicalThickness?.min || 0}-${backingInfo.typicalThickness?.max || 0} ¬µm</strong>
							</div>
							<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dbeafe;">
								<span>Elongation:</span>
								<strong>${backingInfo.elongation || 0}%</strong>
							</div>
							<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #dbeafe;">
								<span>Temp Range:</span>
								<strong>${backingInfo.temperatureRange?.min || 0}¬∞C to ${backingInfo.temperatureRange?.max || 0}¬∞C</strong>
							</div>
							<div style="display: flex; justify-content: space-between; padding: 4px 0;">
								<span>UV Resistance:</span>
								<strong style="text-transform: capitalize;">${backingInfo.uvResistance || 'N/A'}</strong>
							</div>
						</div>
						<p style="margin: 12px 0 0 0; font-size: 0.8rem; color: #6b7280; font-style: italic;">${backingInfo.description || ''}</p>
					</div>
					` : ''}
				`;
				document.getElementById('widthInput').addEventListener('change', (e) => {
					state.params.width = Number(e.target.value);
					addHistory(`Width set to ${e.target.value}`);
					renderContent();
				});
				document.getElementById('heightInput').addEventListener('change', (e) => {
					state.params.height = Number(e.target.value);
					addHistory(`Height set to ${e.target.value}`);
					renderContent();
				});
				break;			case 'specifics':
				// Calculate tape properties using imported function
				const calculationParams = {
					...state.params,
					timeImpactDays: state.timeImpactDays || 0
				};
				
				const props = window.calculateTapeProperties ? 
					window.calculateTapeProperties(calculationParams) : 
					{ peel: '2.60', hold: '6.50', stretch: '25.0', totalThickness: 120 };
				
				// Get adhesive info
				const adhesiveInfo = window.getMaterialInfo ? 
					window.getMaterialInfo('adhesive', state.params.adhesive) : null;
				
				panel.innerHTML = `
					<h2>Specifics</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Adhesive properties and calculated performance metrics</p>
					<div class="form-grid">
						<div class="form-group">
							<label style="display: flex; align-items: center; gap: 8px;">
								Adhesive Thickness (¬µm)
								<span style="font-size: 0.75rem; color: #6b7280; font-weight: 400;">(affects contact area)</span>
							</label>
							<input type="number" id="thicknessInput" value="${state.params.thickness}" min="10" max="500" step="5" />
						</div>
						<div class="form-group">
							<label>Adhesive Type</label>
							<select id="adhesiveSelect">
								<option ${state.params.adhesive === 'Acrylic' ? 'selected' : ''}>Acrylic</option>
								<option ${state.params.adhesive === 'Rubber' ? 'selected' : ''}>Rubber</option>
								<option ${state.params.adhesive === 'Silicone' ? 'selected' : ''}>Silicone</option>
							</select>
						</div>
					</div>
					
					${adhesiveInfo ? `
					<div style="margin-top: 16px; padding: 14px; background: #fffbeb; border: 2px solid #fde68a; border-radius: 8px;">
						<h3 style="margin: 0 0 8px 0; font-size: 0.9rem; color: #92400e; font-weight: 600;">Adhesive: ${adhesiveInfo.name}</h3>
						<div style="font-size: 0.8rem; line-height: 1.6; color: #78350f;">
							<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
								<div style="padding: 4px 0;"><strong>Tack:</strong> ${adhesiveInfo.tackLevel || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>UV:</strong> ${adhesiveInfo.uvResistance || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>Aging:</strong> ${adhesiveInfo.agingStability || 'N/A'}</div>
								<div style="padding: 4px 0;"><strong>Temp:</strong> ${adhesiveInfo.temperatureRange?.min || 0}¬∞C to ${adhesiveInfo.temperatureRange?.max || 0}¬∞C</div>
							</div>
							<p style="margin: 4px 0 0 0; font-size: 0.75rem; font-style: italic;">${adhesiveInfo.description || ''}</p>
						</div>
					</div>
					` : ''}
					
					<div style="margin-top: 20px; padding: 16px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 8px;">
						<h3 style="margin: 0 0 12px 0; font-size: 1rem; color: #166534; font-weight: 600;">Calculated Performance</h3>
						<div style="display: flex; flex-direction: column; gap: 10px;">
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Peel Adhesion:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.peel} N/cm</span>
							</div>
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Shear/Hold Strength:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.hold} N/cm¬≤</span>
							</div>
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #fff; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Elongation at Break:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.stretch}%</span>
							</div>
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #dcfce7; border-radius: 4px;">
								<span style="font-weight: 500; color: #166534;">Total Thickness:</span>
								<span style="font-weight: 700; color: #15803d; font-size: 1.15rem;">${props.totalThickness} ¬µm</span>
							</div>
						</div>
						<p style="margin: 12px 0 0 0; font-size: 0.75rem; color: #166534; font-style: italic;">Values calculated based on ${state.params.tape} backing + ${state.params.adhesive} adhesive on ${state.params.surface} surface in ${state.params.environment} conditions.</p>
					</div>
				`;
				
				// Add event listeners to update parameters and recalculate
				const thicknessInput = document.getElementById('thicknessInput');
				const adhesiveSelect = document.getElementById('adhesiveSelect');
				
				thicknessInput.addEventListener('change', (e) => {
					state.params.thickness = parseInt(e.target.value) || 120;
					saveState();
					renderContent('specifics');
				});
				
				adhesiveSelect.addEventListener('change', (e) => {
					state.params.adhesive = e.target.value;
					saveState();
					renderContent('specifics');
				});
				break;			case 'environment':
				// Get environment data from imported module
				const envConditions = window.ENVIRONMENTAL_CONDITIONS || {
					'Humid': { name: 'Humid', temperature: { min: 15, max: 25 }, humidity: { min: 70, max: 90 }, description: 'High moisture', adhesionMultiplier: 0.75 },
					'Tropical': { name: 'Tropical', temperature: { min: 25, max: 35 }, humidity: { min: 75, max: 95 }, description: 'Hot & humid', adhesionMultiplier: 0.65 },
					'Semiarid': { name: 'Semiarid', temperature: { min: 20, max: 30 }, humidity: { min: 30, max: 50 }, description: 'Balanced', adhesionMultiplier: 0.95 },
					'Arid': { name: 'Arid', temperature: { min: 25, max: 40 }, humidity: { min: 10, max: 30 }, description: 'Hot & dry', adhesionMultiplier: 0.85 },
					'Dry': { name: 'Dry', temperature: { min: 18, max: 25 }, humidity: { min: 20, max: 40 }, description: 'Ideal', adhesionMultiplier: 1.0 }
				};
				
				const currentEnv = envConditions[state.params.environment] || envConditions['Dry'];
				
				panel.innerHTML = `
					<h2>Environment</h2>
					<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Climate conditions affect adhesive performance significantly</p>
					<div style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px;">
						${['Humid', 'Tropical', 'Semiarid', 'Arid', 'Dry'].map(env => {
							const envInfo = envConditions[env];
							const isSelected = state.params.environment === env;
							const performanceClass = envInfo.adhesionMultiplier >= 0.95 ? 'excellent' : 
													 envInfo.adhesionMultiplier >= 0.80 ? 'good' : 
													 envInfo.adhesionMultiplier >= 0.70 ? 'fair' : 'poor';
							const performanceColor = performanceClass === 'excellent' ? '#10b981' : 
													 performanceClass === 'good' ? '#3b82f6' : 
													 performanceClass === 'fair' ? '#f59e0b' : '#ef4444';
							return `
							<div class="environment-choice ${isSelected ? 'selected' : ''}" 
								 data-env="${env}"
								 style="border: 2px solid ${isSelected ? '#2563eb' : '#d1d5db'}; 
										border-radius: 6px; 
										padding: 12px 16px; 
										background: ${isSelected ? '#eff6ff' : '#fff'}; 
										cursor: pointer;
										transition: all 0.2s ease;">
								<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
									<span style="font-weight: ${isSelected ? '600' : '500'}; color: #1f2937;">‚Ä¢ ${envInfo.name || env}</span>
									<span style="font-size: 0.7rem; padding: 2px 8px; background: ${performanceColor}; color: #fff; border-radius: 12px; text-transform: uppercase; font-weight: 600;">${performanceClass}</span>
								</div>
								<div style="display: flex; gap: 16px; font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">
									<span>üå°Ô∏è ${envInfo.temperature.min}-${envInfo.temperature.max}¬∞C</span>
									<span>üíß ${envInfo.humidity.min}-${envInfo.humidity.max}%</span>
								</div>
								<div style="font-size: 0.75rem; color: #9ca3af; font-style: italic;">${envInfo.description || ''}</div>
							</div>
						`}).join('')}
					</div>
					
					<div style="margin-top: 20px; padding: 14px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px;">
						<h3 style="margin: 0 0 8px 0; font-size: 0.9rem; color: #92400e; font-weight: 600;">Current: ${currentEnv.name || state.params.environment}</h3>
						<div style="font-size: 0.8rem; line-height: 1.7; color: #78350f;">
							<div style="margin-bottom: 6px;"><strong>Adhesion Factor:</strong> ${(currentEnv.adhesionMultiplier * 100).toFixed(0)}% of baseline</div>
							<div style="margin-bottom: 6px;"><strong>Aging Rate:</strong> ${currentEnv.agingFactor ? (currentEnv.agingFactor * 100).toFixed(0) + '% of normal' : 'Standard'}</div>
							<p style="margin: 8px 0 0 0; font-size: 0.75rem; font-style: italic; border-top: 1px solid #fcd34d; padding-top: 8px;">${currentEnv.description || 'Environmental conditions impact adhesive tack, wet-out, and long-term stability.'}</p>
						</div>
					</div>
				`;
				
				// Add click handlers for environment choices
				document.querySelectorAll('.environment-choice').forEach(choice => {
					choice.addEventListener('click', () => {
						const env = choice.getAttribute('data-env');
						state.params.environment = env;
						updatePlaygroundBackground(env);
						saveState();
						renderContent('environment');
					});
					
					choice.addEventListener('mouseenter', function() {
						if (state.params.environment !== this.getAttribute('data-env')) {
							this.style.background = '#f3f4f6';
							this.style.borderColor = '#9ca3af';
						}
					});
					
					choice.addEventListener('mouseleave', function() {
						if (state.params.environment !== this.getAttribute('data-env')) {
							this.style.background = '#fff';
							this.style.borderColor = '#d1d5db';
						}
					});
				});
				break;
			case 'history':
				panel.innerHTML = `
					<h2>Saved Experiments</h2>
					${state.experiments.length === 0 ? '<div style="color: #6b7280;">No experiments saved yet.</div>' : `
						<div style="display: flex; flex-direction: column; gap: 12px;">
							${state.experiments.map((exp, idx) => `
								<div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 12px; background: #f9fafb;">
									<div style="font-weight: 600; margin-bottom: 8px;">${exp.name}</div>
									<div style="font-size: 0.85rem; color: #4b5563; line-height: 1.5;">
										<div><strong>Dimensions:</strong> ${exp.data.width} √ó ${exp.data.height} mm</div>
										<div><strong>Tape Material:</strong> ${exp.data.tape}</div>
										<div><strong>Surface Material:</strong> ${exp.data.surface}</div>
										<div><strong>Environment:</strong> ${exp.data.environment || 'Dry'}</div>
										<div><strong>Thickness:</strong> ${exp.data.thickness} ¬µm</div>
										<div><strong>Adhesive:</strong> ${exp.data.adhesive}</div>
									</div>
								</div>
							`).join('')}
						</div>
					`}
				`;
				break;
			case 'variant':
				const tape1 = state.mixedTapes.tape1;
				const tape2 = state.mixedTapes.tape2;
				
				if (!tape1 || !tape2) {
					panel.innerHTML = `
						<h2>Tape Variant</h2>
						<p style="color: #6b7280; font-size: 0.95rem;">Select two tape types from the "Tape Material" button in the bottom bar to see mixed properties.</p>
					`;
				} else {
					// Calculate mixed properties
					const mixedProps = window.calculateMixedTapeProperties ? 
						window.calculateMixedTapeProperties({
							tape1: tape1,
							tape2: tape2,
							surface: state.params.surface,
							adhesive: state.params.adhesive,
							environment: state.params.environment,
							thickness: state.params.thickness,
							timeImpactDays: state.timeImpactDays
						}) : { peel: 'N/A', hold: 'N/A', stretch: 'N/A', totalThickness: 'N/A' };
					
					panel.innerHTML = `
						<h2>Tape Variant - Mixed Properties</h2>
						<p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 16px;">Combined properties of ${tape1} and ${tape2}</p>
						
						<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
							<div style="background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px; padding: 16px;">
								<div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">Tape 1</div>
								<div style="font-size: 1.1rem; font-weight: 600; color: #1e40af;">${tape1}</div>
							</div>
							<div style="background: #f0f9ff; border: 2px solid #bfdbfe; border-radius: 8px; padding: 16px;">
								<div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">Tape 2</div>
								<div style="font-size: 1.1rem; font-weight: 600; color: #1e40af;">${tape2}</div>
							</div>
						</div>
						
						<div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 20px;">
							<h3 style="margin: 0 0 16px 0; font-size: 1.1rem; color: #92400e;">Mixed Tape Properties</h3>
							<div style="display: grid; gap: 12px; font-size: 0.9rem;">
								<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px;">
									<span>Peel Adhesion:</span>
									<strong>${mixedProps.peel} N/cm</strong>
								</div>
								<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px;">
									<span>Hold Strength:</span>
									<strong>${mixedProps.hold} N/cm¬≤</strong>
								</div>
								<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px;">
									<span>Stretch:</span>
									<strong>${mixedProps.stretch}%</strong>
								</div>
								<div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 255, 255, 0.5); border-radius: 4px;">
									<span>Total Thickness:</span>
									<strong>${mixedProps.totalThickness} ¬µm</strong>
								</div>
							</div>
						</div>
						
						<p style="margin-top: 16px; font-size: 0.85rem; color: #6b7280; font-style: italic;">
							Note: Mixed properties are calculated by averaging the characteristics of both tape types.
						</p>
					`;
				}
				break;
			}
			// Add guidelines if active
			if (state.showGuidelines && state.activePanel !== 'history') {
				panel.innerHTML += `
					<div class="guidelines-box">
						<h3>Guidelines</h3>
						<p style="font-size: 0.9rem; line-height: 1.6; margin: 0 0 12px 0;">
							This is a locally made website with the help of AI and simple maths. To simulate real-world situations, environment behaviour, tape stickiness, tape strength, after-peel damage of new/existing tape variants. This is specifically made as a testing playground for my first Product UX RDI (research/design/innovation) case.
						</p>
						<p style="font-size: 0.9rem; line-height: 1.6; margin: 0;">
							For More visit the LinkedIn page where I post the structured presentation on my research (coming soon on 17-11-25)
						</p>
				</div>
				<div class="qr-code show">
					<img src="./images/LinkedIn_QR.png" alt="" />
				</div>
			`;
						} else {
				// Hide QR code when guidelines are not shown
			}
		}

		// Sidebar button handlers (click to open, click again to close)
		document.querySelectorAll('.sidebar-btn[data-panel], .save-btn[data-panel]').forEach(btn => {
			btn.addEventListener('click', (e) => {
				e.stopPropagation();
				const panelName = btn.getAttribute('data-panel');

				// Special case: save
				if (panelName === 'save') {
					const experimentNum = state.experiments.length + 1;
					const timestamp = new Date().toLocaleString();
					const experimentName = `Tape Experiment ${experimentNum} - ${timestamp}`;
					const snapshot = {
						id: experimentNum,
						name: experimentName,
						timestamp: timestamp,
						data: { ...state.params }
					};
					state.experiments.push(snapshot);
					addHistory(`Saved experiment: ${experimentName}`);
					saveState();
					
					// Show save indicator
					const saveNotice = document.getElementById('saveNotice');
					saveNotice.textContent = `‚úì Experiment ${experimentNum} Saved`;
					saveNotice.classList.add('show');
					setTimeout(() => saveNotice.classList.remove('show'), 2500);
					
					// If history panel is open, refresh it
					if (state.activePanel === 'history') {
						renderContent('history');
					}
					return;
				}

				// Toggle behavior: if clicking the already-open panel, close it
				if (state.activePanel === panelName) {
					state.activePanel = null;
					state.showGuidelines = false;
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					document.getElementById('contentPanel').innerHTML = '';
					addHistory(`Closed ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
					return;
				}

				// Guidelines toggles the guidelines overlay within the panel
				if (panelName === 'guidelines') {
					state.showGuidelines = true;
					state.activePanel = 'guidelines';
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					renderContent();
					addHistory('Opened Guidelines');
					return;
				}

				// Open a new panel
				state.activePanel = panelName;
				state.showGuidelines = false;
				document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				renderContent();
				addHistory(`Opened ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
			});
		});

		// Reset button
		document.getElementById('resetBtn').addEventListener('click', () => {
			state.params = { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic' };
			state.history = [];
			state.experiments = [];
			state.activePanel = 'dimensions';
			state.showGuidelines = false;
			state.materialPanel = { tape: false, surface: false };
			localStorage.clear();
			location.reload();
		});

		// Material popup windows with pills (tape) and grid tiles (surface)
		const tapePopup = document.getElementById('tapePopup');
		const surfacePopup = document.getElementById('surfacePopup');
		const tapePillsContainer1 = document.getElementById('tapePills1');
		const tapePillsContainer2 = document.getElementById('tapePills2');
		const surfaceGridContainer = document.getElementById('surfaceGrid');

		// Extended tape options
		const tapeMaterials = [
			{ name: 'PVC', display: 'PVC (Polyvinyl Chloride)' },
			{ name: 'PET', display: 'PET (Polyester Film)' },
			{ name: 'PP', display: 'PP (Polypropylene)' },
			{ name: 'BOPP', display: 'BOPP (Biaxially Oriented Polypropylene)' },
			{ name: 'Paper', display: 'Paper Tape' },
			{ name: 'Cloth', display: 'Cloth / Fabric' },
			{ name: 'Foam', display: 'Foam / Cushion' }
		];

		// Surface materials with texture images
		const surfaceMaterials = [
			{ name: 'Steel', label: 'Steel', image: './images/textures/steel.jpeg' },
			{ name: 'Aluminum', label: 'Aluminum', image: './images/textures/aluminum.jpeg' },
			{ name: 'Glass', label: 'Glass', image: './images/textures/glass.png' },
			{ name: 'Textured Glass', label: 'Textured Glass', image: './images/textures/textured_glass.png' },
			{ name: 'Plastic Bag', label: 'Plastic Bag', image: './images/textures/plastic_bag.jpeg' },
			{ name: 'Door Veneer', label: 'Door Veneer', image: './images/textures/door_veneer.jpeg' },
			{ name: 'Paper Note', label: 'Paper Note', image: './images/textures/paper_note.png' },
			{ name: 'Manga Paper', label: 'Manga Paper', image: './images/textures/manga_paper.jpeg' },
			{ name: 'Sketchbook Paper', label: 'Sketchbook Paper', image: './images/textures/sketchbook_paper.jpeg' },
			{ name: 'Rough Carton', label: 'Rough Carton', image: './images/textures/rough_carton.jpeg' },
			{ name: 'Wall Paint', label: 'Wall Paint', image: './images/textures/wall_paint.jpeg' },
			{ name: 'Damaged Wall Paint', label: 'Damaged Wall Paint', image: './images/textures/damaged_wall_paint.jpeg' },
			{ name: 'Photo', label: 'Photo', image: './images/textures/photo.png' }
		];

		// Populate tape pills - Column 1
		tapeMaterials.forEach(mat => {
			const pill = document.createElement('div');
			pill.className = 'material-pill';
			if (mat.name === state.mixedTapes.tape1) pill.classList.add('selected');
			pill.textContent = mat.display;
			pill.addEventListener('click', () => {
				state.mixedTapes.tape1 = mat.name;
				addHistory(`Tape 1 selected: ${mat.name}`);
				updatePillSelection();
				renderContent();
			});
			tapePillsContainer1.appendChild(pill);
		});

		// Populate tape pills - Column 2
		tapeMaterials.forEach(mat => {
			const pill = document.createElement('div');
			pill.className = 'material-pill';
			if (mat.name === state.mixedTapes.tape2) pill.classList.add('selected');
			pill.textContent = mat.display;
			pill.addEventListener('click', () => {
				state.mixedTapes.tape2 = mat.name;
				addHistory(`Tape 2 selected: ${mat.name}`);
				updatePillSelection();
				renderContent();
			});
			tapePillsContainer2.appendChild(pill);
		});

		// Populate surface tiles
		surfaceMaterials.forEach(mat => {
			const wrap = document.createElement('div');
			wrap.className = 'material-tile-wrap';
			
			const tile = document.createElement('div');
			tile.className = 'material-tile';
			if (mat.name === state.params.surface) tile.classList.add('selected');
			
			const img = document.createElement('img');
			img.src = mat.image;
			img.alt = mat.label;
			tile.appendChild(img);
			
			const label = document.createElement('div');
			label.className = 'material-tile-label';
			label.textContent = mat.label;
			
			wrap.appendChild(tile);
			wrap.appendChild(label);
			
			wrap.addEventListener('click', () => {
				state.params.surface = mat.name;
				addHistory(`Surface selected: ${mat.name}`);
				updateTileSelection();
				closeSurfacePopup();
				renderContent();
			});
			
			surfaceGridContainer.appendChild(wrap);
		});

		function updatePillSelection() {
			// Update column 1
			const pills1 = tapePillsContainer1.querySelectorAll('.material-pill');
			pills1.forEach((pill, index) => {
				pill.classList.remove('selected');
				if (tapeMaterials[index].name === state.mixedTapes.tape1) {
					pill.classList.add('selected');
				}
			});
			
			// Update column 2
			const pills2 = tapePillsContainer2.querySelectorAll('.material-pill');
			pills2.forEach((pill, index) => {
				pill.classList.remove('selected');
				if (tapeMaterials[index].name === state.mixedTapes.tape2) {
					pill.classList.add('selected');
				}
			});
		}

		function updateTileSelection() {
			document.querySelectorAll('.material-tile').forEach(tile => {
				tile.classList.remove('selected');
			});
			const tiles = Array.from(document.querySelectorAll('.material-tile-wrap'));
			const selectedTile = tiles.find(wrap => {
				const label = wrap.querySelector('.material-tile-label').textContent;
				const mat = surfaceMaterials.find(m => m.label === label);
				return mat && mat.name === state.params.surface;
			});
			if (selectedTile) selectedTile.querySelector('.material-tile').classList.add('selected');
		}

		// Popup control functions
		function openTapePopup() {
			tapePopup.classList.add('open');
			closeSurfacePopup();
		}

		function closeTapePopup() {
			tapePopup.classList.remove('open');
		}

		function toggleTapePopup() {
			tapePopup.classList.contains('open') ? closeTapePopup() : openTapePopup();
		}

		function openSurfacePopup() {
			surfacePopup.classList.add('open');
			closeTapePopup();
		}

		function closeSurfacePopup() {
			surfacePopup.classList.remove('open');
		}

		function toggleSurfacePopup() {
			surfacePopup.classList.contains('open') ? closeSurfacePopup() : openSurfacePopup();
		}

		// Button event listeners
		document.getElementById('tapeMaterialBtn').addEventListener('click', toggleTapePopup);
		document.getElementById('surfaceMaterialBtn').addEventListener('click', toggleSurfacePopup);
		document.getElementById('closeTapePopup').addEventListener('click', closeTapePopup);
		document.getElementById('closeSurfacePopup').addEventListener('click', closeSurfacePopup);

		// Close popups on outside click
		document.addEventListener('click', (e) => {
			const path = e.composedPath ? e.composedPath() : (e.path || []);
			if (!path.includes(tapePopup) && !path.includes(document.getElementById('tapeMaterialBtn'))) {
				closeTapePopup();
			}
			if (!path.includes(surfacePopup) && !path.includes(document.getElementById('surfaceMaterialBtn'))) {
				closeSurfacePopup();
			}
		});

		// Close popups on ESC key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape') {
				closeTapePopup();
				closeSurfacePopup();
			}
		});

		// Sync scrollbar thumbs with scroll position
		const tapeFrame = document.querySelector('#tapePopup .popup-frame');
		const surfaceFrame = document.querySelector('#surfacePopup .popup-frame');
		const tapeThumb = document.getElementById('tapeScrollThumb');
		const surfaceThumb = document.getElementById('surfaceScrollThumb');

		function syncScrollbar(frame, thumb) {
			if (!frame || !thumb) return;
			const track = thumb.parentElement;
			const maxTop = track.clientHeight - thumb.clientHeight;
			const scrollRatio = frame.scrollTop / Math.max(1, (frame.scrollHeight - frame.clientHeight));
			thumb.style.top = `${Math.round(scrollRatio * maxTop)}px`;
		}

		if (tapeFrame) tapeFrame.addEventListener('scroll', () => syncScrollbar(tapeFrame, tapeThumb));
		if (surfaceFrame) surfaceFrame.addEventListener('scroll', () => syncScrollbar(surfaceFrame, surfaceThumb));

		// Variant button - opens the variant panel in the sidebar
		document.getElementById('variantBtn').addEventListener('click', () => {
			state.activePanel = 'variant';
			state.showGuidelines = false;
			document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
			renderContent();
			addHistory('Opened Variant panel');
		});

		// Floating tooltip behavior: show a top-level tooltip so it won't be clipped by sidebar overflow
        function setupFloatingTooltips() {
            const tip = document.querySelector('.floating-tip');
            const elementsWithTips = document.querySelectorAll('[data-tip]');
            let showTimeout, hideTimeout;

            elementsWithTips.forEach(elem => {
                elem.addEventListener('mouseenter', (e) => {
                    clearTimeout(hideTimeout);
                    const tipText = elem.getAttribute('data-tip');
                    showTimeout = setTimeout(() => {
                        tip.textContent = tipText;
                        tip.style.display = 'block';
                        tip.classList.add('show');
                        tip.setAttribute('aria-hidden', 'false');
                        
                        const rect = elem.getBoundingClientRect();
                        let left = rect.left + rect.width / 2;
                        let top = rect.top - 10;

                        if (left + 75 > window.innerWidth) left = window.innerWidth - 80;
                        if (left - 75 < 0) left = 80;
                        if (top < 30) top = rect.bottom + 10;

                        tip.style.left = left + 'px';
                        tip.style.top = top + 'px';
                    }, 50);
                });

                elem.addEventListener('mouseleave', () => {
                    clearTimeout(showTimeout);
                    hideTimeout = setTimeout(() => {
                        tip.classList.remove('show');
                        tip.setAttribute('aria-hidden', 'true');
                        setTimeout(() => {
                            tip.style.display = 'none';
                        }, 120);
                    }, 1000);
                });
            });
        }		setupFloatingTooltips();

		// Preview button - toggle preview mode
		document.getElementById('previewBtn').addEventListener('click', () => {
			state.previewMode = !state.previewMode;
			const sidebar = document.querySelector('.sidebar');
			const bottombar = document.querySelector('.bottombar');
			const playground = document.querySelector('.playground');
			const contentPanel = document.querySelector('.content-panel');
			const previewBtn = document.getElementById('previewBtn');

			if (state.previewMode) {
				sidebar.classList.add('hidden');
				bottombar.classList.add('hidden');
				playground.classList.add('preview-mode');
				previewBtn.classList.add('active');
				addHistory('Entered Preview mode');
			} else {
				sidebar.classList.remove('hidden');
				bottombar.classList.remove('hidden');
				playground.classList.remove('preview-mode');
				previewBtn.classList.remove('active');
				addHistory('Exited Preview mode');
			}
			togglePreviewHint();
			togglePreviewSlider();
		});
		
		// Show/hide preview hint
		function togglePreviewHint() {
			const hint = document.getElementById('previewHint');
			if (state.previewMode) {
				hint.classList.add('show');
			} else {
				hint.classList.remove('show');
			}
		}
		
		// Show/hide preview slider
		function togglePreviewSlider() {
			const slider = document.getElementById('previewSlider');
			if (state.previewMode) {
				slider.classList.add('show');
			} else {
				slider.classList.remove('show');
			}
		}

		// Allow ESC key to exit preview mode
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && state.previewMode) {
				document.getElementById('previewBtn').click();
			}
		});

		// Function to update playground background based on environment
		function updatePlaygroundBackground(environment) {
			const background = document.getElementById('playgroundBackground');
			if (!background) return;
			
			const imageMap = {
				'Humid': './images/Humid.jpg',
				'Tropical': './images/Tropical.jpg',
				'Semiarid': './images/Semiarid.jpg',
				'Arid': './images/Arid.jpg',
				'Dry': './images/Dry.jpg'
			};
			
			const imagePath = imageMap[environment];
			if (imagePath) {
				background.style.backgroundImage = `url('${imagePath}')`;
				background.classList.add('visible');
			} else {
				background.classList.remove('visible');
			}
		}

		// Initialize
		function initializeApp() {
			loadState();
			renderContent();
			updatePlaygroundBackground(state.params.environment || 'Dry');
			document.querySelectorAll('.sidebar-btn[data-panel]').forEach(btn => {
				if (btn.getAttribute('data-panel') === state.activePanel) {
					btn.classList.add('active');
				}
			});
		}
		
		// Wait for math module to load before initializing
		if (window.mathModuleLoaded) {
			initializeApp();
		} else {
			window.addEventListener('mathModuleReady', initializeApp);
		}

		// Time Impact Slider functionality
		function initTimeSlider() {
			const slider = document.getElementById('timeSlider');
			const valueDisplay = document.getElementById('sliderValue');
			
			if (!slider || !valueDisplay) {
				console.error('Slider elements not found:', { slider, valueDisplay });
				return;
			}

			console.log('Initializing slider...', slider, valueDisplay);

			// Update display and state when slider changes
			slider.addEventListener('input', (e) => {
				const value = parseInt(e.target.value);
				console.log('Slider input:', value);
				valueDisplay.textContent = value;
				state.timeImpactDays = value;
				
				// Recalculate specifics if that panel is open
				if (state.activePanel === 'specifics') {
					renderContent();
				}
			});

			// Add history entry when user releases slider
			slider.addEventListener('change', (e) => {
				const value = parseInt(e.target.value);
				console.log('Slider change:', value);
				addHistory(`Time impact set to ${value} days`);
			});
			
			// Set initial value
			valueDisplay.textContent = '0';
		}

		// Call initTimeSlider after DOM is fully loaded
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initTimeSlider);
		} else {
			initTimeSlider();
		}
	</script>
</body>
</html>
