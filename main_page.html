<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Tape Testing UI - Responsive demo with sidebar, playground, and controls" />
	<title>TapeTesting</title>
	<!-- Link CSS files for responsive layouts -->
	<link rel="stylesheet" href="./display and css/desktop.css" />
	<link rel="stylesheet" href="./display and css/tablet.css" />
	<link rel="stylesheet" href="./display and css/phone.css" />
	<style>
		:root {
			--gap: 16px;
			--item-bg: #f3f4f6;
			--accent: #0ea5a4;
			--sidebar-width: 20vw;
			--bottom-height: calc(20vh - 15px);
			--sidebar-height: auto;
			--primary-color: #2563eb;
			--secondary-color: #fef3c7;
		}

		html, body {
			height: 100%;
			margin: 0;
			font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			background: #fff;
		}

		body {
			display: flex;
			flex-direction: column;
		}

		/* Main app layout */
		.app-container {
			display: flex;
			flex: 1;
			position: relative;
			min-height: 100vh;
		}

		/* Sidebar */
		.sidebar {
			position: fixed;
			left: 0;
			top: 0;
			bottom: 0;
			width: var(--sidebar-width);
			background: #fff;
			border-right: 4px solid var(--primary-color);
			padding: 16px;
			box-sizing: border-box;
			z-index: 2;
			overflow-y: auto;
			display: flex;
			flex-direction: column;
			gap: 16px;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.sidebar.hidden {
			transform: translateX(-100%);
			opacity: 0;
			pointer-events: none;
		}

		.sidebar-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			border-radius: 4px;
			padding: 12px 16px;
			background: #fff;
			cursor: pointer;
			font-size: 0.95rem;
			transition: all 0.2s ease;
			display: flex;
			align-items: center;
			justify-content: space-between;
			text-align: left;
		}

		/* Tooltip for sidebar buttons (small helper text on hover) */
		/* Hide the earlier pseudo-element tooltips; we'll use a floating tooltip appended to <body> */
		.sidebar-btn[data-tip]::after,
		.sidebar-btn[data-tip]::before,
		.preview-btn[data-tip]::after,
		.preview-btn[data-tip]::before {
			display: none !important;
		}

		/* Floating tooltip that sits on top of everything */
		.floating-tip {
			position: fixed;
			display: none;
			background: rgba(17, 24, 39, 0.95);
			color: #fff;
			padding: 6px 10px;
			border-radius: 6px;
			font-size: 0.78rem;
			white-space: nowrap;
			z-index: 99999;
			pointer-events: none; /* disabled until visible so it won't block interactions */
			box-shadow: 0 8px 24px rgba(0,0,0,0.2);
			transition: opacity 0.12s ease;
			opacity: 0;
		}

		.floating-tip.show {
			display: block;
			opacity: 1;
			pointer-events: auto; /* allow mouse to enter the tip itself so it can cancel hide */
		}

		.sidebar-btn:hover {
			background: #eff6ff;
		}

		.sidebar-btn.active {
			background: #eff6ff;
			border-color: #1e40af;
		}

		.sidebar-btn svg {
			width: 18px;
			height: 18px;
			stroke: currentColor;
		}

		.sidebar-divider {
			border-top: 1px solid #93c5fd;
			margin: 8px 0;
		}

		/* Preview button - full width, distinct styling */
		.preview-btn {
			position: relative;
			width: 100%;
			border: 2px solid var(--primary-color);
			background: var(--primary-color);
			color: #fff;
			border-radius: 4px;
			padding: 12px 16px;
			cursor: pointer;
			font-size: 0.95rem;
			font-weight: 600;
			transition: all 0.2s ease;
		}

		.preview-btn:hover {
			background: #1e40af;
			border-color: #1e40af;
		}

		.preview-btn.active {
			background: #fff;
			color: var(--primary-color);
			border-color: var(--primary-color);
		}

		/* Playground / Main content area */
		.playground {
			margin-left: var(--sidebar-width);
			margin-bottom: calc(var(--bottom-height) + 50px);
			padding: 20px;
			box-sizing: border-box;
			overflow-y: auto;
			background: #fff;
			flex: 1;
			transition: margin-left 0.3s ease, margin-bottom 0.3s ease;
		}

		.playground.preview-mode {
			margin-left: 0;
			margin-bottom: 0;
		}

		.content-panel {
			border: 4px solid var(--primary-color);
			border-radius: 4px;
			background: #f9fafb;
			padding: 24px;
			overflow-y: auto;
			max-height: 100%;
			padding-bottom: 40px;
		}

		.content-panel h2 {
			font-size: 1.5rem;
			font-weight: 600;
			margin: 0 0 16px 0;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 16px;
			max-width: 400px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.form-group label {
			font-size: 0.9rem;
			font-weight: 500;
		}

		.form-group input,
		.form-group select {
			padding: 8px 12px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			font-size: 0.95rem;
			box-sizing: border-box;
		}

		.form-group input:focus,
		.form-group select:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}

		.preview-box {
			margin: 24px 0;
			padding: 16px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			background: #fff;
			min-height: 200px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.preview-content {
			text-align: center;
			border: 2px dashed #d1d5db;
			padding: 40px;
			border-radius: 4px;
			width: 100%;
		}

		.preview-content .title {
			font-size: 1.1rem;
			font-weight: 500;
		}

		.preview-content .subtitle {
			font-size: 0.9rem;
			color: #6b7280;
			margin-top: 8px;
		}

		.history-list {
			list-style: none;
			padding: 0;
			margin: 0;
			max-height: 280px;
			overflow-y: auto;
		}

		.history-list li {
			padding: 8px;
			font-size: 0.85rem;
			border-bottom: 1px solid #e5e7eb;
		}

		.history-list li:last-child {
			border-bottom: none;
		}

		.guidelines-box {
			margin-top: 24px;
			padding: 16px;
			border: 1px solid #fbbf24;
			background: #fef3c7;
			border-radius: 4px;
		}

		.guidelines-box h3 {
			margin: 0 0 12px 0;
			font-weight: 600;
		}

		.guidelines-box ol {
			margin: 0;
			padding-left: 20px;
			font-size: 0.9rem;
		}

		/* Middle section - above bottom bar */
		.middlebar {
			position: fixed;
			left: var(--sidebar-width);
			right: 0;
			bottom: var(--bottom-height);
			height: 50px;
			background: #fff;
			border-top: 4px solid var(--primary-color);
			padding: 0 95px;
			box-sizing: border-box;
			z-index: 2;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.middlebar-line {
			width: 100%;
			height: 4px;
			background: #e5e7eb;
			border-radius: 2px;
			position: relative;
			margin: 20px 0;
			cursor: pointer;
		}

		.slider-progress {
			position: absolute;
			left: 0;
			top: 0;
			height: 100%;
			background: var(--primary-color);
			border-radius: 2px;
			width: 0%;
			pointer-events: none;
			transition: width 0.05s ease;
		}

		.slider-handle {
			position: absolute;
			top: 50%;
			left: 0%;
			transform: translate(-50%, -50%);
			width: 16px;
			height: 16px;
			background: var(--primary-color);
			border: 2px solid #fff;
			border-radius: 50%;
			cursor: grab;
			box-shadow: 0 2px 6px rgba(0,0,0,0.15);
			transition: transform 0.05s ease, box-shadow 0.2s ease;
			z-index: 2;
		}

		.slider-handle:hover {
			box-shadow: 0 3px 10px rgba(0,0,0,0.25);
			transform: translate(-50%, -50%) scale(1.15);
		}

		.slider-handle:active,
		.slider-handle.dragging {
			cursor: grabbing;
			box-shadow: 0 4px 14px rgba(0,0,0,0.3);
			transform: translate(-50%, -50%) scale(1.2);
		}

		.middlebar-labels {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 100%;
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			padding: 0 95px;
			box-sizing: border-box;
			pointer-events: none;
		}

		/* Left and right gap containers for labels (centered in the padding gaps)
		   The .middlebar-line defines the visible slider line; these containers
		   occupy the left/right padding area and center their content. */
		.middlebar-gap {
			width: 95px; /* matches middlebar padding */
			height: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			pointer-events: none;
		}

		/* Left gap: keep label near the sidebar edge */
		.middlebar-gap:first-child {
			justify-content: flex-start;
		}

		.middlebar-gap:first-child span {
			margin-left: -40px; /* move 40px closer to sidebar edge */
		}

		/* Right gap: align label toward the display edge and nudge outward */
		.middlebar-gap:last-child {
			justify-content: flex-end;
		}

		.middlebar-gap:last-child span {
			margin-right: -40px; /* move 40px closer to display edge - mirrors left */
		}

		.middlebar-gap span {
			font-size: 0.9rem;
			font-weight: 600;
			color: var(--primary-color);
			display: inline-block;
			transform: translateY(-2px); /* small vertical nudge so it visually clears the line */
		}

		.middlebar.hidden {
			transform: translateY(100%);
			opacity: 0;
			pointer-events: none;
		}

		/* Bottom bar */
		.bottombar {
			position: fixed;
			left: 0;
			right: 0;
			bottom: 0;
			height: var(--bottom-height);
			background: #fff;
			border-top: 4px solid var(--primary-color);
			padding: 0;
			box-sizing: border-box;
			z-index: 3;
			display: flex;
			align-items: center;
			justify-content: space-between;
			overflow: hidden;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}

		.bottombar.hidden {
			transform: translateY(100%);
			opacity: 0;
			pointer-events: none;
		}

		.bottom-content {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			height: 100%;
			padding: 40px 20px;
			box-sizing: border-box;
			gap: 20px;
		}

		.material-selector {
			position: relative;
			display: flex;
			flex: 1;
			min-width: 0;
		}

		.material-btn {
			border: 2px solid var(--primary-color);
			background: #fff;
			border-radius: 4px;
			padding: 8px 17px;
			cursor: pointer;
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			transition: all 0.2s ease;
			flex: 1;
			min-width: 0;
		}

		.material-btn:hover {
			background: #eff6ff;
		}

		.material-badge {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			background: #fbcfe8;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.material-dropdown {
			position: fixed;
			width: 160px;
			background: #fff;
			border: 2px solid #93c5fd;
			border-radius: 4px;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
			padding: 12px;
			z-index: 100000;
			display: none;
			pointer-events: auto;
		}

		.material-dropdown.open {
			display: block;
		}

		.material-dropdown .title {
			font-weight: 600;
			margin-bottom: 8px;
			font-size: 0.9rem;
		}

		.material-option {
			width: 100%;
			padding: 8px;
			border: 1px solid #e5e7eb;
			border-radius: 4px;
			background: #fff;
			cursor: pointer;
			font-size: 0.85rem;
			margin-bottom: 4px;
			text-align: left;
			transition: all 0.2s ease;
		}

		.material-option:last-child {
			margin-bottom: 0;
		}

		.material-option:hover {
			background: #eff6ff;
		}

		.material-option.selected {
			background: #eff6ff;
			border-color: var(--primary-color);
		}

		.bottom-right {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 12px;
			margin-left: auto;
			flex-shrink: 0;
		}

		.bottom-right .status {
			font-size: 0.85rem;
			color: #4b5563;
		}

		.apply-btn {
			padding: 8px 16px;
			border: 1px solid var(--primary-color);
			background: #fff;
			color: var(--primary-color);
			border-radius: 4px;
			cursor: pointer;
			font-weight: 500;
			transition: all 0.2s ease;
		}

		.apply-btn:hover {
			background: #eff6ff;
		}

		.save-notice {
			position: fixed;
			bottom: 30px;
			right: 20px;
			background: #dcfce7;
			border: 1px solid #86efac;
			padding: 12px 16px;
			border-radius: 4px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			z-index: 50;
			display: none;
		}

		.save-notice.show {
			display: block;
		}

		/* Preview mode hint */
		.preview-hint {
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0, 0, 0, 0.7);
			color: #fff;
			padding: 12px 20px;
			border-radius: 24px;
			font-size: 0.85rem;
			text-align: center;
			z-index: 40;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
		}

		.preview-hint.show {
			opacity: 1;
			pointer-events: auto;
		}

		/* Phone/responsive */
		@media (max-width: 480px) {
			:root {
				--sidebar-width: 100vw;
				--bottom-height: 20vh;
				--sidebar-height: 20vh;
			}

			.sidebar {
				position: fixed;
				left: 0;
				right: 0;
				top: 0;
				height: var(--sidebar-height);
				width: 100%;
				bottom: auto;
				border-right: none;
				border-bottom: 4px solid var(--primary-color);
				z-index: 3;
				flex-direction: row;
				overflow-x: auto;
				padding: 8px;
			}

			.sidebar-btn {
				flex-shrink: 0;
				min-width: 100px;
				padding: 8px 12px;
				font-size: 0.85rem;
			}

			.sidebar-divider {
				display: none;
			}

			.playground {
				margin-left: 0;
				margin-top: var(--sidebar-height);
				margin-bottom: var(--bottom-height);
				min-height: calc(100vh - var(--sidebar-height) - var(--bottom-height));
			}

			.bottombar {
				left: 0;
				right: 0;
				bottom: 0;
			}

			.middlebar {
				left: 0;
				right: 0;
				bottom: var(--bottom-height);
			}

			.bottom-content {
				flex-wrap: wrap;
				justify-content: center;
				padding: 8px 12px;
			}

			.bottom-right {
				width: 100%;
				justify-content: center;
				margin-left: 0;
				margin-top: 8px;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar -->
		<aside class="sidebar" aria-label="Sidebar">
			<button class="sidebar-btn active" data-panel="dimensions" data-tip="Set width & height">
				<span>Dimensions</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="specifics" data-tip="Thickness, adhesive, tolerances">
				<span>Specifics</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>
			<button class="sidebar-btn" data-panel="environment" data-tip="Temperature & humidity">
				<span>Environment</span>
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
				</svg>
			</button>

			<button class="preview-btn" id="previewBtn" title="Preview mode - hides sidebar and bottom bar" data-tip="Toggle full-screen preview">
				Preview
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" data-panel="save" data-tip="Download current parameters as JSON">
				Save Parameters
			</button>

			<button class="sidebar-btn" data-panel="history" data-tip="View recent changes">
				History Log
			</button>

			<button class="sidebar-btn" data-panel="guidelines" data-tip="Show design guidelines">
				Guidelines
			</button>

			<div class="sidebar-divider"></div>

			<button class="sidebar-btn" id="resetBtn" data-tip="Reset all parameters">
				RESET
			</button>
		</aside>

		<!-- Main Playground -->
		<section class="playground" aria-label="Playground">
			<div class="content-panel" id="contentPanel">
				<!-- Content inserted here by JS -->
			</div>
		</section>

		<!-- Middle Section - above bottom bar -->
		<div class="middlebar" aria-label="Middle bar">
			<div class="middlebar-line" id="sliderTrack" data-tip="Time Impact Slider">
				<div class="slider-progress" id="sliderProgress"></div>
				<div class="slider-handle" id="sliderHandle"></div>
			</div>
			<div class="middlebar-labels">
				<div class="middlebar-gap"><span>0</span></div>
				<div class="middlebar-gap"><span id="sliderValue">366</span></div>
			</div>
		</div>

		<!-- Bottom Bar -->
		<div class="bottombar" aria-label="Bottom bar">
			<div class="bottom-content">
				<div class="material-selector">
					<button class="material-btn" id="tapeMaterialBtn">
						<span class="material-badge">T</span>
						<span>Tape Material</span>
					</button>
					<div class="material-dropdown" id="tapeMaterialDropdown">
						<div class="title">Tape Material</div>
						<!-- Options added by JS -->
					</div>
				</div>

				<div class="material-selector">
					<button class="material-btn" id="surfaceMaterialBtn">
						<span class="material-badge">S</span>
						<span>Surface Material</span>
					</button>
					<div class="material-dropdown" id="surfaceMaterialDropdown">
						<div class="title">Surface Material</div>
						<!-- Options added by JS -->
					</div>
				</div>

				<div class="bottom-right">
					<div class="status" id="statusText">Current: PVC on Steel</div>
					<button class="apply-btn" id="applyBtn">Apply</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Save notice -->
	<div class="save-notice" id="saveNotice">Saved</div>

	<!-- Scripts -->
	<!-- Preview mode hint -->
	<div class="preview-hint" id="previewHint">Press ESC to exit preview mode</div>

	<!-- Floating tooltip shown above all content -->
	<div id="floatingTip" class="floating-tip" aria-hidden="true"></div>

	<script type="module" src="./display and css/desktop_size.js"></script>
	<script type="module" src="./display and css/tablet_size.js"></script>
	<script type="module" src="./display and css/phone_size.js"></script>

	<script>
		// UI State
		const state = {
			activePanel: 'dimensions',
			params: { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic' },
			history: [],
			experiments: [],
			showGuidelines: false,
			materialPanel: { tape: false, surface: false },
			previewMode: false
		};

		const tapeOptions = ['PVC', 'Polypropylene', 'Cloth', 'Foam'];
		const surfaceOptions = ['Steel', 'Aluminum', 'Glass', 'Plastic'];

		// Load from localStorage
		function loadState() {
			const saved = localStorage.getItem('tape_ui_params');
			if (saved) state.params = JSON.parse(saved);
			const savedHistory = localStorage.getItem('tape_ui_history');
			if (savedHistory) state.history = JSON.parse(savedHistory);
			const savedExperiments = localStorage.getItem('tape_ui_experiments');
			if (savedExperiments) state.experiments = JSON.parse(savedExperiments);
		}

		// Save to localStorage
		function saveState() {
			localStorage.setItem('tape_ui_params', JSON.stringify(state.params));
			localStorage.setItem('tape_ui_history', JSON.stringify(state.history));
			localStorage.setItem('tape_ui_experiments', JSON.stringify(state.experiments));
		}

		// Add history entry
		function addHistory(entry) {
			const time = new Date().toLocaleString();
			state.history.unshift({ time, text: entry });
			state.history = state.history.slice(0, 50);
			saveState();
		}

		// Render content based on active panel
		function renderContent() {
			const panel = document.getElementById('contentPanel');
			// Clear panel first so closing a panel removes its content immediately
			panel.innerHTML = '';
			const { width, height } = state.params;

			switch (state.activePanel) {
				case 'dimensions':
					panel.innerHTML = `
						<h2>Dimensions</h2>
						<div class="form-grid">
							<div class="form-group">
								<label>Width (mm)</label>
								<input type="number" id="widthInput" value="${width}" />
							</div>
							<div class="form-group">
								<label>Height (mm)</label>
								<input type="number" id="heightInput" value="${height}" />
							</div>
						</div>
					`;
					document.getElementById('widthInput').addEventListener('change', (e) => {
						state.params.width = Number(e.target.value);
						addHistory(`Width set to ${e.target.value}`);
						renderContent();
					});
					document.getElementById('heightInput').addEventListener('change', (e) => {
						state.params.height = Number(e.target.value);
						addHistory(`Height set to ${e.target.value}`);
						renderContent();
					});
					break;

				case 'specifics':
					panel.innerHTML = `
						<h2>Specifics</h2>
						<p>Specific parameters: thickness, adhesive type, colour, tolerances, notes.</p>
						<div class="form-grid">
							<div class="form-group">
								<label>Thickness (µm)</label>
								<input type="number" value="120" />
							</div>
							<div class="form-group">
								<label>Adhesive</label>
								<select>
									<option>Acrylic</option>
									<option>Rubber</option>
									<option>Silicone</option>
								</select>
							</div>
						</div>
					`;
					break;

				case 'environment':
					panel.innerHTML = `
						<h2>Environment</h2>
						<p>Choose environmental conditions used for the calculation / preview.</p>
						<div class="form-grid">
							<div class="form-group">
								<label>Temperature (°C)</label>
								<input type="number" value="23" />
							</div>
							<div class="form-group">
								<label>Humidity (%)</label>
								<input type="number" value="50" />
							</div>
						</div>
					`;
					break;


			case 'history':
				panel.innerHTML = `
					<h2>Saved Experiments</h2>
					${state.experiments.length === 0 ? '<div style="color: #6b7280;">No experiments saved yet.</div>' : `
						<div style="display: flex; flex-direction: column; gap: 12px;">
							${state.experiments.map((exp, idx) => `
								<div style="border: 1px solid #e5e7eb; border-radius: 4px; padding: 12px; background: #f9fafb;">
									<div style="font-weight: 600; margin-bottom: 8px;">${exp.name}</div>
									<div style="font-size: 0.85rem; color: #4b5563; line-height: 1.5;">
										<div><strong>Dimensions:</strong> ${exp.data.width} × ${exp.data.height} mm</div>
										<div><strong>Tape Material:</strong> ${exp.data.tape}</div>
										<div><strong>Surface Material:</strong> ${exp.data.surface}</div>
										<div><strong>Environment:</strong> ${exp.data.temperature}°C, ${exp.data.humidity}% humidity</div>
										<div><strong>Thickness:</strong> ${exp.data.thickness} µm</div>
										<div><strong>Adhesive:</strong> ${exp.data.adhesive}</div>
									</div>
								</div>
							`).join('')}
						</div>
					`}
				`;
				break;
			}
			// Add guidelines if active
			if (state.showGuidelines && state.activePanel !== 'history') {
				panel.innerHTML += `
					<div class="guidelines-box">
						<h3>Guidelines</h3>
						<ol>
							<li>Keep safety margins in the design.</li>
							<li>Validate adhesion on a sample first.</li>
							<li>Record environment conditions with the build.</li>
						</ol>
					</div>
				`;
			}
		}

		// Sidebar button handlers (click to open, click again to close)
		document.querySelectorAll('.sidebar-btn[data-panel]').forEach(btn => {
			btn.addEventListener('click', (e) => {
				e.stopPropagation();
				const panelName = btn.getAttribute('data-panel');

				// Special case: save
				if (panelName === 'save') {
					const experimentNum = state.experiments.length + 1;
					const timestamp = new Date().toLocaleString();
					const experimentName = `Tape Experiment ${experimentNum} - ${timestamp}`;
					const snapshot = {
						id: experimentNum,
						name: experimentName,
						timestamp: timestamp,
						data: { ...state.params }
					};
					state.experiments.push(snapshot);
					addHistory(`Saved experiment: ${experimentName}`);
					saveState();
					document.getElementById('saveNotice').classList.add('show');
					setTimeout(() => document.getElementById('saveNotice').classList.remove('show'), 2000);
					return;
				}

				// Toggle behavior: if clicking the already-open panel, close it
				if (state.activePanel === panelName) {
					state.activePanel = null;
					state.showGuidelines = false;
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					document.getElementById('contentPanel').innerHTML = '';
					addHistory(`Closed ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
					return;
				}

				// Guidelines toggles the guidelines overlay within the panel
				if (panelName === 'guidelines') {
					state.showGuidelines = true;
					state.activePanel = 'guidelines';
					document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
					btn.classList.add('active');
					renderContent();
					addHistory('Opened Guidelines');
					return;
				}

				// Open a new panel
				state.activePanel = panelName;
				state.showGuidelines = false;
				document.querySelectorAll('.sidebar-btn[data-panel]').forEach(b => b.classList.remove('active'));
				btn.classList.add('active');
				renderContent();
				addHistory(`Opened ${panelName.charAt(0).toUpperCase() + panelName.slice(1)}`);
			});
		});

		// Reset button
		document.getElementById('resetBtn').addEventListener('click', () => {
			state.params = { width: 100, height: 80, tape: 'PVC', surface: 'Steel', temperature: 23, humidity: 50, thickness: 120, adhesive: 'Acrylic' };
			state.history = [];
			state.experiments = [];
			state.activePanel = 'dimensions';
			state.showGuidelines = false;
			state.materialPanel = { tape: false, surface: false };
			localStorage.clear();
			location.reload();
		});

		// Material selector buttons
		function setupMaterialSelector(btnId, dropdownId, optionsArray, key) {
			const btn = document.getElementById(btnId);
			const dropdown = document.getElementById(dropdownId);
			const titleDiv = dropdown.querySelector('.title');

			// Populate options
			optionsArray.forEach(opt => {
				const optBtn = document.createElement('button');
				optBtn.className = 'material-option';
				optBtn.textContent = opt;
				if (opt === state.params[key]) optBtn.classList.add('selected');
				optBtn.addEventListener('click', () => {
					state.params[key] = opt;
					document.getElementById('statusText').textContent = `Current: ${state.params.tape} on ${state.params.surface}`;
					addHistory(`${key === 'tape' ? 'Tape' : 'Surface'} selected: ${opt}`);
					dropdown.classList.remove('open');
					renderContent();
				});
				dropdown.appendChild(optBtn);
			});

			// Position and toggle dropdown on click only
			btn.addEventListener('click', (e) => {
				e.stopPropagation();
				const isOpen = dropdown.classList.contains('open');
				
				if (!isOpen) {
					// Close all other dropdowns first
					document.querySelectorAll('.material-dropdown.open').forEach(d => {
						if (d !== dropdown) d.classList.remove('open');
					});
					
					// Position dropdown as fixed popup above the button
					const rect = btn.getBoundingClientRect();
					dropdown.style.left = (rect.left + window.scrollX) + 'px';
					dropdown.style.top = (rect.top + window.scrollY - 10) + 'px';
					dropdown.style.transform = 'translateY(-100%)';
					
					dropdown.classList.add('open');
				} else {
					dropdown.classList.remove('open');
				}
			});

			// Close on outside click
			document.addEventListener('click', (e) => {
				if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
					dropdown.classList.remove('open');
				}
			});
		}

		setupMaterialSelector('tapeMaterialBtn', 'tapeMaterialDropdown', tapeOptions, 'tape');
		setupMaterialSelector('surfaceMaterialBtn', 'surfaceMaterialDropdown', surfaceOptions, 'surface');

		// Apply button
		document.getElementById('applyBtn').addEventListener('click', () => {
			addHistory(`Applied ${state.params.tape} to ${state.params.surface}`);
		});

		// Floating tooltip behavior: show a top-level tooltip so it won't be clipped by sidebar overflow
        function setupFloatingTooltips() {
            const tip = document.querySelector('.floating-tip');
            const elementsWithTips = document.querySelectorAll('[data-tip]');
            let showTimeout, hideTimeout;

            elementsWithTips.forEach(elem => {
                elem.addEventListener('mouseenter', (e) => {
                    clearTimeout(hideTimeout);
                    const tipText = elem.getAttribute('data-tip');
                    showTimeout = setTimeout(() => {
                        tip.textContent = tipText;
                        tip.style.display = 'block';
                        tip.classList.add('show');
                        tip.setAttribute('aria-hidden', 'false');
                        
                        const rect = elem.getBoundingClientRect();
                        let left = rect.left + rect.width / 2;
                        let top = rect.top - 10;

                        if (left + 75 > window.innerWidth) left = window.innerWidth - 80;
                        if (left - 75 < 0) left = 80;
                        if (top < 30) top = rect.bottom + 10;

                        tip.style.left = left + 'px';
                        tip.style.top = top + 'px';
                    }, 50);
                });

                elem.addEventListener('mouseleave', () => {
                    clearTimeout(showTimeout);
                    hideTimeout = setTimeout(() => {
                        tip.classList.remove('show');
                        tip.setAttribute('aria-hidden', 'true');
                        setTimeout(() => {
                            tip.style.display = 'none';
                        }, 120);
                    }, 1000);
                });
            });
        }		setupFloatingTooltips();

		// Preview button - toggle preview mode
		document.getElementById('previewBtn').addEventListener('click', () => {
			state.previewMode = !state.previewMode;
			const sidebar = document.querySelector('.sidebar');
			const middlebar = document.querySelector('.middlebar');
			const bottombar = document.querySelector('.bottombar');
			const playground = document.querySelector('.playground');
			const previewBtn = document.getElementById('previewBtn');

			if (state.previewMode) {
				sidebar.classList.add('hidden');
				middlebar.classList.add('hidden');
				bottombar.classList.add('hidden');
				playground.classList.add('preview-mode');
				previewBtn.classList.add('active');
				addHistory('Entered Preview mode');
			} else {
				sidebar.classList.remove('hidden');
				middlebar.classList.remove('hidden');
				bottombar.classList.remove('hidden');
				playground.classList.remove('preview-mode');
				previewBtn.classList.remove('active');
				addHistory('Exited Preview mode');
			}
			togglePreviewHint();
		});
		
		// Show/hide preview hint
		function togglePreviewHint() {
			const hint = document.getElementById('previewHint');
			if (state.previewMode) {
				hint.classList.add('show');
			} else {
				hint.classList.remove('show');
			}
		}
		
		// Update preview button to show hint
		const originalPreviewClick = document.getElementById('previewBtn').onclick;
		document.getElementById('previewBtn').addEventListener('click', () => {
			setTimeout(togglePreviewHint, 100);
		});

		// Allow ESC key to exit preview mode
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && state.previewMode) {
				document.getElementById('previewBtn').click();
			}
		});

		// Initialize
		loadState();
		renderContent();
		document.querySelectorAll('.sidebar-btn[data-panel]').forEach(btn => {
			if (btn.getAttribute('data-panel') === state.activePanel) {
				btn.classList.add('active');
			}
		});

		// Time Impact Slider functionality
		function initTimeSlider() {
			const track = document.getElementById('sliderTrack');
			const handle = document.getElementById('sliderHandle');
			const progress = document.getElementById('sliderProgress');
			const valueDisplay = document.getElementById('sliderValue');
			
			if (!track || !handle || !progress || !valueDisplay) return;

			let sliderValue = 366; // default to max (366 days)
			let isDragging = false;

			function updateSlider(clientX) {
				const rect = track.getBoundingClientRect();
				let percentage = ((clientX - rect.left) / rect.width) * 100;
				percentage = Math.max(0, Math.min(100, percentage));
				
				const value = Math.round((percentage / 100) * 366);
				sliderValue = value;
				
				handle.style.left = percentage + '%';
				progress.style.width = percentage + '%';
				valueDisplay.textContent = value;
			}

			// Click on track to move handle
			track.addEventListener('click', (e) => {
				if (e.target === handle) return;
				updateSlider(e.clientX);
			});

			// Drag handle
			handle.addEventListener('mousedown', (e) => {
				isDragging = true;
				handle.classList.add('dragging');
				e.preventDefault();
			});

			document.addEventListener('mousemove', (e) => {
				if (!isDragging) return;
				updateSlider(e.clientX);
			});

			document.addEventListener('mouseup', () => {
				if (isDragging) {
					isDragging = false;
					handle.classList.remove('dragging');
					addHistory(`Time impact set to ${sliderValue} days`);
				}
			});

			// Touch support
			handle.addEventListener('touchstart', (e) => {
				isDragging = true;
				handle.classList.add('dragging');
				e.preventDefault();
			});

			document.addEventListener('touchmove', (e) => {
				if (!isDragging) return;
				const touch = e.touches[0];
				updateSlider(touch.clientX);
			});

			document.addEventListener('touchend', () => {
				if (isDragging) {
					isDragging = false;
					handle.classList.remove('dragging');
					addHistory(`Time impact set to ${sliderValue} days`);
				}
			});

			// Initialize at max value (366)
			handle.style.left = '100%';
			progress.style.width = '100%';
		}

		initTimeSlider();
	</script>
</body>
</html>
